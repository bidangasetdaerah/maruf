<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Dashboard Rekap Data Kecamatan</title>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body{font-family:Arial, sans-serif;margin:20px;}
    table{border-collapse:collapse;width:100%;margin-bottom:20px;}
    th,td{border:1px solid #ccc;padding:8px;text-align:left;}
    th{background:#f0f0f0;}
    .chart-container{width:400px;height:400px;display:inline-block;}
    select{margin:5px 0;padding:5px;}
  </style>
</head>
<body>
  <h1>Dashboard Rekap Data Kecamatan</h1>

  <label for="filterKecamatan">Pilih Kecamatan:</label>
  <select id="filterKecamatan" onchange="onKecamatanChange()"></select>

  <label for="filterSekolah">Pilih Sekolah:</label>
  <select id="filterSekolah" onchange="updateData()"></select>

  <h2>Rekap Data Kecamatan</h2>
  <table id="rekapTable">
    <thead>
      <tr>
        <th rowspan="2">Kecamatan</th>
        <th rowspan="2">Jumlah Sekolah</th>
        <th rowspan="2">Jumlah Barang</th>
        <th rowspan="2">Nilai Total (Rp)</th>
        <th colspan="3">Kondisi Sebelumnya</th>
        <th colspan="3">Kondisi Saat Ini</th>
      </tr>
      <tr>
        <th>Baik</th>
        <th>Rusak Ringan</th>
        <th>Rusak Berat</th>
        <th>Baik</th>
        <th>Rusak Ringan</th>
        <th>Rusak Berat</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <div class="chart-container"><canvas id="chartKondisi"></canvas></div>

  <h2>Detail Sekolah</h2>
  <div id="detailSekolah"></div>

  <script>
    const kecamatanEndpoints = {
      "Banawa": "https://docs.google.com/spreadsheets/d/e/2PACX-1vRd8vIhHDUbmD6I2aXLX7-_Ysemt2aXA__wKNGoKN0XWWSWCScv5aSmx06H0xkl8g/pub?gid=1917777904&single=true&output=csv",
      "Banawa Tengah": "https://docs.google.com/spreadsheets/d/e/2PACX-1vRnykw5e_i3dwBIeTua-mpFExEJ4w6hROJ5F6OUHiiGpbtunldeKgXlhN_G-D1V8w/pub?gid=1454720232&single=true&output=csv",
      "Banawa Selatan": "https://docs.google.com/spreadsheets/d/e/2PACX-1vRhDJK33BtCz7KEi6DWgqheZBrcdgK0X9Pw1r28u5ec1MK-I-kP-QOqrsY0G2OnEQ/pub?gid=708970016&single=true&output=csv",
      "Rio Pakava": "https://docs.google.com/spreadsheets/d/1_8YllqyTXGDZZCVeozFKAhGru2WS15Bp/export?format=csv",
      "Pinembani": "https://docs.google.com/spreadsheets/d/e/2PACX-1vQshgCYmG0DHxcwLUzhtUamXTYnWb8tR7WQwnJq9k7ldFz_JhV4GHDE-k_dMO_pSA/pub?gid=1860451546&single=true&output=csv",
      "Tanantovea": "https://docs.google.com/spreadsheets/d/e/2PACX-1vR3MhjBMD3q8UIfOTdAUOHKMdeGcwr3y2YQGFcDmHDd0IVsOsAECl511LsNJ9ynow9cmY4yBpP1jENa/pub?gid=1200528899&single=true&output=csv",
      "Labuan": "https://docs.google.com/spreadsheets/d/e/2PACX-1vT7WqNsmpUBIy0-lVm2JdGg1KUKwNgQPpbSyDuuFDwB1aGPY8gsZSBWmxIgiOeJNA/pub?gid=1615242439&single=true&output=csv",
      "Sindue": "https://docs.google.com/spreadsheets/d/e/2PACX-1vQ2sjcmJjTCYD3p6-7pDQTmm3mCVphZIP2-5DGZOHxStucexMcdqPVsfsbnDouFcA/pub?gid=1920885371&single=true&output=csv",
      "Sindue Tombusabora": "https://docs.google.com/spreadsheets/d/e/2PACX-1vRYHOyrOQ_hNjC1L1FoIMVbbWES0dPGb1OaU6V--PV_lm0O97IHFvtPRhgRNXn_dA/pub?gid=1974330298&single=true&output=csv",
      "Sindue Tobata": "https://docs.google.com/spreadsheets/d/e/2PACX-1vQIbvzs-jZRcf1z0uV_Ahwh6dNdBgBHw66T358D9wd0-DHimDs8r4ajCvZwLa8Srg/pub?gid=801352666&single=true&output=csv",
      "Sirenja": "https://docs.google.com/spreadsheets/d/e/2PACX-1vROhU6H6reNQxHKsAmYYgfcaSZyis1vALTmBkYhjAp7BGX_wNdA2cVdgOjFQIIgjQ/pub?output=csv",
      "Balaesang": "https://docs.google.com/spreadsheets/d/e/2PACX-1vQIf6mV6qgS6fmRe3jz305N8wCDdKWJcKKWSxHtybbo7xoERx15unD-x4rgyFxF-g/pub?gid=1401841928&single=true&output=csv",
      "Balaesang Tanjung": "https://docs.google.com/spreadsheets/d/e/2PACX-1vQRojLHXJ4W6IEdiNn34kZrMgr5QvPZllm85-sbgD0WxjG6vFMUMQz3QzzGnM-7pw/pub?gid=820099832&single=true&output=csv",
      "Dampelas": "https://docs.google.com/spreadsheets/d/e/2PACX-1vR_BmCgfv-HOMRKzNMZ1aHL05CZsR7Ie0VZGRJTD29tX1C-ANiKASW1hB_PM69WuQ/pub?gid=1489077321&single=true&output=csv",
      "Sojol": "https://docs.google.com/spreadsheets/d/e/2PACX-1vT64A3AbrmT4TK8fLj5ctUc3LLMESXVTOuw3nBd2qRTEFIljaxTBW3-Z5u4w7W2Ng/pub?gid=1781390946&single=true&output=csv",
      "Sojol Utara": "https://docs.google.com/spreadsheets/d/e/2PACX-1vT41KwECicPb2EY8d8BP1f73RM3dhVWYDOxpaFlHZluKFy9owLzyVX7N7mIUm37Tw/pub?gid=502544387&single=true&output=csv"
    };

    let dataKecamatan = {};
    let chartInstance = null;

    async function fetchData(url){
      return new Promise((resolve,reject)=>{
        Papa.parse(url,{
          download:true,
          header:true,
          complete: res=> resolve(res.data),
          error: err=> reject(err)
        });
      });
    }

    function parseNumber(val){
      return parseFloat((val||"0").toString().replace(/[^0-9,.-]/g,"").replace(/\./g,"").replace(/,/g,"."))||0;
    }

    async function loadAllData(){
      for(const [kec,url] of Object.entries(kecamatanEndpoints)){
        const rawData = await fetchData(url);
        dataKecamatan[kec] = rawData.map(r=>({
          sekolah: r["Nama Sekolah"] || r["Pengguna Barang"] || "",
          barang: r["Nama Barang"] || "",
          nibar: r["NIBAR"] || r["No. Register"] || "",
          konfirmasi: r["Konfirmasi Keberadaan"] || "Tidak Ditemukan",
          kondisiSebelumnya: r["Kondisi Sebelumnya"] || "",
          kondisiSaatIni: r["Kondisi Saat Ini"] || "",
          nilai: parseNumber(r["Harga Perolehan"] || r["Nilai Perolehan"])
        }));
      }
      populateFilter();
      updateData();
    }

    function populateFilter(){
      const sel=document.getElementById("filterKecamatan");
      sel.innerHTML="<option value=''>Semua Kecamatan</option>";
      Object.keys(dataKecamatan).forEach(kec=>{
        const o=document.createElement("option");
        o.value=kec;o.textContent=kec;sel.appendChild(o);
      });
      populateSekolah(""); // default kosong
    }

    function onKecamatanChange(){
      const kec=document.getElementById("filterKecamatan").value;
      populateSekolah(kec);
      updateData();
    }

    function populateSekolah(kec){
      const sel=document.getElementById("filterSekolah");
      sel.innerHTML="<option value=''>Semua Sekolah</option>";
      if(!kec) return;
      const sekolahSet=new Set(dataKecamatan[kec].map(r=>r.sekolah).filter(Boolean));
      sekolahSet.forEach(sch=>{
        const o=document.createElement("option");
        o.value=sch;o.textContent=sch;sel.appendChild(o);
      });
    }

    function updateData(){
      const filter=document.getElementById("filterKecamatan").value;
      const sekolahFilter=document.getElementById("filterSekolah").value;
      const tbody=document.querySelector("#rekapTable tbody");
      tbody.innerHTML="";
      let totalSebelum={baik:0,ringan:0,berat:0}, totalSekarang={baik:0,ringan:0,berat:0};
      for(const [kec,rows] of Object.entries(dataKecamatan)){
        if(filter && kec!==filter) continue;
        let sekolahSet=new Set(),barang=0,totalNilai=0;
        let sebelum={baik:0,ringan:0,berat:0}, sekarang={baik:0,ringan:0,berat:0};
        rows.forEach(r=>{
          if(sekolahFilter && r.sekolah!==sekolahFilter) return;
          if(r.sekolah) sekolahSet.add(r.sekolah);
          if(r.barang) barang++;
          totalNilai+=r.nilai;
          if(r.kondisiSebelumnya==="Baik") sebelum.baik++;
          else if(r.kondisiSebelumnya==="Rusak Ringan") sebelum.ringan++;
          else if(r.kondisiSebelumnya==="Rusak Berat") sebelum.berat++;
          if(r.kondisiSaatIni==="Baik") sekarang.baik++;
          else if(r.kondisiSaatIni==="Rusak Ringan") sekarang.ringan++;
          else if(r.kondisiSaatIni==="Rusak Berat") sekarang.berat++;
        });
        totalSebelum.baik+=sebelum.baik; totalSebelum.ringan+=sebelum.ringan; totalSebelum.berat+=sebelum.berat;
        totalSekarang.baik+=sekarang.baik; totalSekarang.ringan+=sekarang.ringan; totalSekarang.berat+=sekarang.berat;
        const tr=document.createElement("tr");
        tr.innerHTML=`<td>${kec}</td><td>${sekolahSet.size}</td><td>${barang}</td><td>${totalNilai.toLocaleString("id-ID")}</td>
          <td>${sebelum.baik}</td><td>${sebelum.ringan}</td><td>${sebelum.berat}</td>
          <td>${sekarang.baik}</td><td>${sekarang.ringan}</td><td>${sekarang.berat}</td>`;
        tbody.appendChild(tr);
      }
      drawChart(totalSekarang.baik,totalSekarang.ringan,totalSekarang.berat);
      showDetail(filter,sekolahFilter);
    }

    function drawChart(baik,ringan,berat){
      const ctx=document.getElementById("chartKondisi").getContext("2d");
      if(chartInstance) chartInstance.destroy();
      chartInstance=new Chart(ctx,{
        type:"pie",
        data:{
          labels:["Baik","Rusak Ringan","Rusak Berat"],
          datasets:[{data:[baik,ringan,berat]}]
        }
      });
    }

    function showDetail(filter,sekolahFilter){
      const container=document.getElementById("detailSekolah");
      container.innerHTML="";
      for(const [kec,rows] of Object.entries(dataKecamatan)){
        if(filter && kec!==filter) continue;
        const sekolahGroup={};
        rows.forEach(r=>{
          if(!r.sekolah) return;
          if(sekolahFilter && r.sekolah!==sekolahFilter) return;
          if(!sekolahGroup[r.sekolah]) sekolahGroup[r.sekolah]=[];
          sekolahGroup[r.sekolah].push(r);
        });
        for(const [sekolah,items] of Object.entries(sekolahGroup)){
          const h3=document.createElement("h3");
          h3.textContent=`${sekolah} (${kec})`;
          container.appendChild(h3);
          const table=document.createElement("table");
          table.innerHTML=`<thead>
            <tr><th>Nama Barang</th><th>NIBAR</th><th>Kondisi Sebelumnya</th><th>Kondisi Saat Ini</th><th>Nilai Perolehan (Rp)</th></tr>
          </thead><tbody></tbody>`;
          const tbody=table.querySelector("tbody");
          items.forEach(it=>{
            const tr=document.createElement("tr");
            tr.innerHTML=`<td>${it.barang}</td><td>${it.nibar}</td><td>${it.kondisiSebelumnya}</td><td>${it.kondisiSaatIni}</td><td>${it.nilai.toLocaleString("id-ID")}</td>`;
            tbody.appendChild(tr);
          });
          container.appendChild(table);
        }
      }
    }

    loadAllData();
  </script>
</body>
</html>
