<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Dashboard Rekap Barang</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {font-family: Arial, sans-serif; margin:20px;}
    table {border-collapse: collapse; width: 100%; margin-bottom:20px;}
    th, td {border:1px solid #ccc; padding:8px; text-align:center;}
    th {background:#f2f2f2;}
    .expand-btn {cursor:pointer; border:none; background:none;}
    .chart-container {width:45%; display:inline-block; vertical-align:top; margin-bottom:20px;}
    .chart-full {width:95%; margin:20px auto;}
    /* Ringkasan tabel responsif */
    .ringkasan table {
      width: 100%;
      border-collapse: collapse;
      margin: 10px 0;
      font-size: 0.9rem;
    }
    .ringkasan th, .ringkasan td {
      border: 1px solid #ddd;
      padding: 6px;
      text-align: center;
    }
    .ringkasan th {
      background: #f7f7f7;
    }
    .ringkasan {
      overflow-x: auto; /* supaya bisa discroll di HP */
    }
  </style>
</head>
<body>
  <h1>Dashboard Rekap Barang</h1>
  <label for="filterKecamatan">Filter Kecamatan:</label>
  <select id="filterKecamatan"></select>
  <label for="searchBox">Cari Sekolah:</label>
  <input type="text" id="searchBox" placeholder="Nama sekolah...">

  <h2>Rekap Kondisi Barang</h2>
  <table id="rekapTable">
    <thead>
      <tr>
        <th>Kecamatan</th>
        <th>Ditemukan</th>
        <th>Tidak Ditemukan</th>
        <th>Baik</th>
        <th>Rusak Ringan</th>
        <th>Rusak Berat</th>
        <th>Nilai Perolehan (Rp)</th>
        <th>Jumlah Sekolah</th>
      </tr>
    </thead>
    <tbody></tbody>
    <tfoot>
      <tr>
        <th>Total</th>
        <td id="totalDitemukan">0</td>
        <td id="totalTidakDitemukan">0</td>
        <td id="totalBaik">0</td>
        <td id="totalRusakRingan">0</td>
        <td id="totalRusakBerat">0</td>
        <td id="totalNilai">0</td>
        <td id="totalSekolah">0</td>
      </tr>
    </tfoot>
  </table>

  <!-- Ringkasan sekolah per kecamatan di bawah tabel -->
  <div id="ringkasanSekolahBawah"></div>

  <div class="chart-container">
    <canvas id="chartDitemukan"></canvas>
  </div>
  <div class="chart-container">
    <canvas id="chartKondisi"></canvas>
  </div>

  <!-- Grafik jumlah sekolah per kecamatan -->
  <div class="chart-full">
    <h3>Jumlah Sekolah per Kecamatan</h3>
    <div id="totalSekolahPerKecamatan"></div>
    <canvas id="chartSekolah"></canvas>
  </div>

  <div id="sekolahSection"></div>

  <p id="lastUpdate"></p>

  <script>
    const kecamatanEndpoints = {
      "Kec1":"url-csv1",
      "Kec2":"url-csv2"
      // tambahkan sesuai kebutuhan
    };
    let dataKecamatan={};

    function parseNumber(str){
      if(!str) return 0;
      return Number(String(str).replace(/[^0-9,-]/g,"").replace(",","."));
    }

    async function fetchData(url){
      const resp=await fetch(url);
      const text=await resp.text();
      const rows=text.split("\n").map(r=>r.split(","));
      const headers=rows[0];
      return rows.slice(1).map(r=>{
        let obj={};
        headers.forEach((h,i)=>obj[h.trim()]=r[i]?r[i].trim():"");
        return obj;
      });
    }

    async function loadAllData(){
      for(const [kec,url] of Object.entries(kecamatanEndpoints)){
        const rawData = await fetchData(url);
        dataKecamatan[kec] = rawData.map(r=>({
          sekolah: r["Pengguna Barang"] || r["Nama Sekolah"] || "",
          barang: r["Nama Barang"] || "",
          nibar: r["NIBAR"] || r["No. Register"] || "",
          konfirmasi: r["Konfirmasi Keberadaan"] || "Tidak Ditemukan",
          kondisi: r["Kondisi"] || "Baik",
          kondisiSaatIni: r["Kondisi Saat Ini"] || "",
          nilai: parseNumber(r["Harga Perolehan"] || r["Nilai Perolehan"])
        }));
      }
      populateFilter();
      updateData();
      setInterval(updateData,300000);
    }

    function cleanSekolahName(name){
      if(!name) return "";
      return name
        .replace(/➕.*$/,"")
        .replace(/Penggunaan.*$/i,"")
        .replace(/Status Pegawai Pengguna.*$/i,"")
        .replace(/Keterangan Tambahan.*$/i,"")
        .trim();
    }

    function populateFilter(){
      const sel=document.getElementById("filterKecamatan");
      sel.innerHTML='<option value="all">Semua</option>';
      Object.keys(dataKecamatan).forEach(k=>{
        const opt=document.createElement("option");
        opt.value=k; opt.textContent=k;
        sel.appendChild(opt);
      });
    }

    function updateData(){
      const filter=document.getElementById("filterKecamatan").value;
      const search=document.getElementById("searchBox").value.toLowerCase();
      const tbody=document.querySelector("#rekapTable tbody");
      tbody.innerHTML="";
      document.getElementById("sekolahSection").innerHTML="";
      let total={Ditemukan:0,Tidak:0,Baik:0,Ringan:0,Berat:0,Nilai:0, Sekolah:0};
      let sekolahPerKecamatan={};

      for(const [kec,data] of Object.entries(dataKecamatan)){
        if(filter!=="all" && filter!==kec) continue;
        let ditemukan=0,tidak=0,baik=0,ringan=0,berat=0,nilai=0;
        const sekolahMap={};

        data.forEach(r=>{
          const namaBersih=cleanSekolahName(r.sekolah);
          if(search && !namaBersih.toLowerCase().includes(search)) return;
          if(r.konfirmasi==="Ditemukan") ditemukan++; else tidak++;
          const kondisiDipakai = r.kondisiSaatIni || r.kondisi;
          if(kondisiDipakai==="Baik") baik++;
          else if(kondisiDipakai==="Rusak Ringan") ringan++;
          else if(kondisiDipakai==="Rusak Berat") berat++;
          nilai+=r.nilai;

          if(!sekolahMap[namaBersih]) sekolahMap[namaBersih]={barang:0,nilai:0,detail:[]};
          sekolahMap[namaBersih].barang++;
          sekolahMap[namaBersih].nilai+=r.nilai;
          sekolahMap[namaBersih].detail.push(r);
        });

        const jumlahSekolah = Object.keys(sekolahMap).length;
        sekolahPerKecamatan[kec]=jumlahSekolah;
        total.Sekolah+=jumlahSekolah;
        total.Ditemukan+=ditemukan; total.Tidak+=tidak;
        total.Baik+=baik; total.Ringan+=ringan; total.Berat+=berat; total.Nilai+=nilai;

        const tr=document.createElement("tr");
        tr.innerHTML=`<td>${kec}</td><td>${ditemukan}</td><td>${tidak}</td>
                      <td>${baik}</td><td>${ringan}</td><td>${berat}</td>
                      <td>${nilai.toLocaleString("id-ID")}</td><td>${jumlahSekolah}</td>`;
        tbody.appendChild(tr);

        // render sekolah detail
        const section=document.getElementById("sekolahSection");
        let html=`<h3>Daftar Sekolah - ${kec}</h3><p><b>Jumlah Sekolah Mengirim Data: ${jumlahSekolah}</b></p>`;
        html+=`<table><thead><tr><th>Nama Sekolah</th><th>Jumlah Barang</th><th>Nilai Perolehan (Rp)</th></tr></thead><tbody>`;
        let idx=0;
        for(const [sName,val] of Object.entries(sekolahMap)){
          idx++; const detailId=`detail_${kec}_${idx}`;
          html+=`<tr><td><button class="expand-btn" onclick="toggleDetail('${detailId}')">➕</button>${sName}</td>
                 <td>${val.barang}</td><td>${val.nilai.toLocaleString("id-ID")}</td></tr>`;
          html+=`<tr id="${detailId}" style="display:none;">
                 <td colspan="3"><table style="width:100%; border:1px solid #ddd; font-size:0.8rem;">
                 <thead><tr><th>Nama Barang</th><th>NIBAR</th><th>Kondisi Saat Ini</th><th>Nilai Perolehan (Rp)</th></tr></thead><tbody>`;
          val.detail.forEach(it=>{
            html+=`<tr><td>${it.barang}</td><td>${it.nibar}</td>
                   <td>${it.kondisiSaatIni || it.kondisi}</td>
                   <td>${it.nilai.toLocaleString("id-ID")}</td></tr>`;
          });
          html+=`</tbody></table></td></tr>`;
        }
        html+=`</tbody></table>`;
        section.innerHTML+=html;
      }

      // update total di footer
      document.getElementById("totalDitemukan").textContent=total.Ditemukan;
      document.getElementById("totalTidakDitemukan").textContent=total.Tidak;
      document.getElementById("totalBaik").textContent=total.Baik;
      document.getElementById("totalRusakRingan").textContent=total.Ringan;
      document.getElementById("totalRusakBerat").textContent=total.Berat;
      document.getElementById("totalNilai").textContent=total.Nilai.toLocaleString("id-ID");
      document.getElementById("totalSekolah").textContent=total.Sekolah;

      // update ringkasan jumlah sekolah per kecamatan (tabel kecil responsif)
      let info = "<div class='ringkasan'><table><thead><tr><th>Kecamatan</th><th>Jumlah Sekolah</th></tr></thead><tbody>";
      for (const [kec, jml] of Object.entries(sekolahPerKecamatan)) {
        info += `<tr><td>${kec}</td><td>${jml}</td></tr>`;
      }
      info += `<tr><th>Total Semua Kecamatan</th><th>${total.Sekolah}</th></tr>`;
      info += "</tbody></table></div>";

      document.getElementById("totalSekolahPerKecamatan").innerHTML = info;
      document.getElementById("ringkasanSekolahBawah").innerHTML = info;

      document.getElementById("lastUpdate").textContent="Data terakhir diperbarui: "+new Date().toLocaleTimeString();
      updateCharts(total,sekolahPerKecamatan);
    }

    function toggleDetail(id){
      const row=document.getElementById(id);
      if(row.style.display==="none"){row.style.display="table-row";}
      else{row.style.display="none";}
    }

    let chartDitemukan, chartKondisi, chartSekolah;
    function updateCharts(total,sekolahPerKecamatan){
      const ctx1=document.getElementById("chartDitemukan").getContext("2d");
      const ctx2=document.getElementById("chartKondisi").getContext("2d");
      const ctx3=document.getElementById("chartSekolah").getContext("2d");

      if(chartDitemukan) chartDitemukan.destroy();
      if(chartKondisi) chartKondisi.destroy();
      if(chartSekolah) chartSekolah.destroy();

      chartDitemukan=new Chart(ctx1,{
        type:"pie",
        data:{
          labels:["Ditemukan","Tidak Ditemukan"],
          datasets:[{data:[total.Ditemukan,total.Tidak]}]
        }
      });

      chartKondisi=new Chart(ctx2,{
        type:"bar",
        data:{
          labels:["Baik","Rusak Ringan","Rusak Berat"],
          datasets:[{data:[total.Baik,total.Ringan,total.Berat]}]
        }
      });

      chartSekolah=new Chart(ctx3,{
        type:"bar",
        data:{
          labels:Object.keys(sekolahPerKecamatan),
          datasets:[{label:"Jumlah Sekolah", data:Object.values(sekolahPerKecamatan)}]
        },
        options:{
          indexAxis:"y"
        }
      });
    }

    document.getElementById("filterKecamatan").addEventListener("change",updateData);
    document.getElementById("searchBox").addEventListener("input",updateData);

    loadAllData();
  </script>
</body>
</html>
