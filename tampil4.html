<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Rekap Data Aset</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; background: #f9f9f9; }
    h1 { text-align: center; }
    .filters { text-align: center; margin-bottom: 20px; }
    table { width: 100%; border-collapse: collapse; background: #fff; margin-bottom: 20px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
    th { background: #eee; }
    .summary, .grand-summary { margin: 20px 0; background: #fff; padding: 10px; border: 1px solid #ccc; }
  </style>
</head>
<body>
  <h1>Rekap Data Aset Per Kecamatan</h1>
  <div class="filters">
    <label for="kecamatan">Pilih Kecamatan:</label>
    <select id="kecamatan"></select>
  </div>

  <div class="summary" id="summary"></div>

  <table id="rekapTable">
    <thead>
      <tr>
        <th>Nama Sekolah</th>
        <th>Jumlah Barang</th>
        <th>Total Nilai Perolehan</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <div class="grand-summary" id="grandSummary"></div>

<script>
  const kecamatanEndpoints = {
    "Banawa": "https://docs.google.com/spreadsheets/d/e/2PACX-1vRd8vIhHDUbmD6I2aXLX7-_Ysemt2aXA__wKNGoKN0XWWSWCScv5aSmx06H0xkl8g/pub?gid=1917777904&single=true&output=csv",
    "Banawa Tengah": "https://docs.google.com/spreadsheets/d/e/2PACX-1vRnykw5e_i3dwBIeTua-mpFExEJ4w6hROJ5F6OUHiiGpbtunldeKgXlhN_G-D1V8w/pub?gid=1454720232&single=true&output=csv",
    "Banawa Selatan": "https://docs.google.com/spreadsheets/d/e/2PACX-1vRhDJK33BtCz7KEi6DWgqheZBrcdgK0X9Pw1r28u5ec1MK-I-kP-QOqrsY0G2OnEQ/pub?gid=708970016&single=true&output=csv",
    "Rio Pakava": "https://docs.google.com/spreadsheets/d/1_8YllqyTXGDZZCVeozFKAhGru2WS15Bp/export?format=csv",
    "Pinembani": "https://docs.google.com/spreadsheets/d/e/2PACX-1vQshgCYmG0DHxcwLUzhtUamXTYnWb8tR7WQwnJq9k7ldFz_JhV4GHDE-k_dMO_pSA/pub?gid=1860451546&single=true&output=csv",
    "Tanantovea": "https://docs.google.com/spreadsheets/d/e/2PACX-1vR3MhjBMD3q8UIfOTdAUOHKMdeGcwr3y2YQGFcDmHDd0IVsOsAECl511LsNJ9ynow9cmY4yBpP1jENa/pub?gid=1200528899&single=true&output=csv",
    "Labuan": "https://docs.google.com/spreadsheets/d/e/2PACX-1vT7WqNsmpUBIy0-lVm2JdGg1KUKwNgQPpbSyDuuFDwB1aGPY8gsZSBWmxIgiOeJNA/pub?gid=1615242439&single=true&output=csv",
    "Sindue": "https://docs.google.com/spreadsheets/d/e/2PACX-1vQ2sjcmJjTCYD3p6-7pDQTmm3mCVphZIP2-5DGZOHxStucexMcdqPVsfsbnDouFcA/pub?gid=1920885371&single=true&output=csv",
    "Sindue Tombusabora": "https://docs.google.com/spreadsheets/d/e/2PACX-1vRYHOyrOQ_hNjC1L1FoIMVbbWES0dPGb1OaU6V--PV_lm0O97IHFvtPRhgRNXn_dA/pub?gid=1974330298&single=true&output=csv",
    "Sindue Tobata": "https://docs.google.com/spreadsheets/d/e/2PACX-1vQIbvzs-jZRcf1z0uV_Ahwh6dNdBgBHw66T358D9wd0-DHimDs8r4ajCvZwLa8Srg/pub?gid=801352666&single=true&output=csv",
    "Sirenja": "https://docs.google.com/spreadsheets/d/e/2PACX-1vROhU6H6reNQxHKsAmYYgfcaSZyis1vALTmBkYhjAp7BGX_wNdA2cVdgOjFQIIgjQ/pub?output=csv",
    "Balaesang": "https://docs.google.com/spreadsheets/d/e/2PACX-1vQIf6mV6qgS6fmRe3jz305N8wCDdKWJcKKWSxHtybbo7xoERx15unD-x4rgyFxF-g/pub?gid=1401841928&single=true&output=csv",
    "Balaesang Tanjung": "https://docs.google.com/spreadsheets/d/e/2PACX-1vQRojLHXJ4W6IEdiNn34kZrMgr5QvPZllm85-sbgD0WxjG6vFMUMQz3QzzGnM-7pw/pub?gid=820099832&single=true&output=csv",
    "Dampelas": "https://docs.google.com/spreadsheets/d/e/2PACX-1vR_BmCgfv-HOMRKzNMZ1aHL05CZsR7Ie0VZGRJTD29tX1C-ANiKASW1hB_PM69WuQ/pub?gid=1489077321&single=true&output=csv",
    "Sojol": "https://docs.google.com/spreadsheets/d/e/2PACX-1vT64A3AbrmT4TK8fLj5ctUc3LLMESXVTOuw3nBd2qRTEFIljaxTBW3-Z5u4w7W2Ng/pub?gid=1781390946&single=true&output=csv",
    "Sojol Utara": "https://docs.google.com/spreadsheets/d/e/2PACX-1vT41KwECicPb2EY8d8BP1f73RM3dhVWYDOxpaFlHZluKFy9owLzyVX7N7mIUm37Tw/pub?gid=502544387&single=true&output=csv"
  };

  let dataKecamatan = {};

  // Parsing angka (Rp)
  function parseNumber(str) {
    if (!str) return 0;
    str = str.trim();
    str = str.replace(/\./g, ""); // hapus titik ribuan
    str = str.replace(/,/g, "."); // koma â†’ desimal
    let num = parseFloat(str);
    return isNaN(num) ? 0 : num;
  }

  function formatRupiah(num) {
    return "Rp " + num.toLocaleString("id-ID");
  }

  // Ambil kolom perolehan fleksibel
  function getNilai(r) {
    for (const key of Object.keys(r)) {
      if (key.toLowerCase().includes("perolehan")) {
        return parseNumber(r[key]);
      }
    }
    return 0;
  }

  // Parser CSV aman (support tanda kutip)
  function parseCSV(text) {
    const rows = [];
    let current = "", row = [], inQuotes = false;

    for (let i = 0; i < text.length; i++) {
      const c = text[i];

      if (c === '"' && text[i+1] === '"') {
        current += '"'; i++;
      } else if (c === '"') {
        inQuotes = !inQuotes;
      } else if (c === ',' && !inQuotes) {
        row.push(current.trim());
        current = "";
      } else if ((c === '\n' || c === '\r') && !inQuotes) {
        if (current || row.length) {
          row.push(current.trim());
          rows.push(row);
        }
        row = [];
        current = "";
      } else {
        current += c;
      }
    }
    if (current || row.length) {
      row.push(current.trim());
      rows.push(row);
    }
    return rows;
  }

  async function fetchData(url){
    const resp = await fetch(url);
    const text = await resp.text();
    const rows = parseCSV(text);
    const headers = rows[0];
    return rows.slice(1).map(r=>{
      let obj={};
      headers.forEach((h,i)=>obj[h.trim()] = r[i] ? r[i].trim() : "");
      return obj;
    });
  }

  async function loadAllData(){
    for(const [kec,url] of Object.entries(kecamatanEndpoints)){
      const rawData = await fetchData(url);
      dataKecamatan[kec] = rawData.map(r=>{
        let sekolah = r["Pengguna Barang"] || r["Nama Sekolah"] || "";
        if (sekolah.includes("Penggunaan") || sekolah.includes("Status Pegawai") || sekolah.includes("Keterangan")) {
          return null;
        }
        return {
          sekolah,
          barang: r["Nama Barang"] || "",
          nibar: r["NIBAR"] || r["No. Register"] || "",
          nilai: getNilai(r)
        };
      }).filter(x=>x!==null);
    }
    populateFilter();
    updateData();
    setInterval(updateData,300000);
  }

  function populateFilter(){
    const sel = document.getElementById("kecamatan");
    sel.innerHTML = "";
    for(const k of Object.keys(kecamatanEndpoints)){
      const opt = document.createElement("option");
      opt.value = k; opt.textContent = k;
      sel.appendChild(opt);
    }
    sel.addEventListener("change", updateData);
  }

  function updateData(){
    const kec = document.getElementById("kecamatan").value;
    const data = dataKecamatan[kec] || [];
    const summaryDiv = document.getElementById("summary");
    const tableBody = document.querySelector("#rekapTable tbody");
    tableBody.innerHTML = "";

    let totalBarang = data.length;
    let totalNilai = data.reduce((a,b)=>a+b.nilai,0);

    summaryDiv.innerHTML = `
      <strong>Kecamatan:</strong> ${kec}<br>
      <strong>Jumlah Barang:</strong> ${totalBarang}<br>
      <strong>Total Nilai Perolehan:</strong> ${formatRupiah(totalNilai)}
    `;

    // Rekap per sekolah
    let sekolahMap = {};
    data.forEach(d=>{
      if(!sekolahMap[d.sekolah]) sekolahMap[d.sekolah] = {jumlah:0, nilai:0};
      sekolahMap[d.sekolah].jumlah++;
      sekolahMap[d.sekolah].nilai += d.nilai;
    });

    for(const [sekolah, val] of Object.entries(sekolahMap)){
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${sekolah}</td>
        <td>${val.jumlah}</td>
        <td>${formatRupiah(val.nilai)}</td>
      `;
      tableBody.appendChild(tr);
    }

    updateGrandSummary();
  }

  function updateGrandSummary(){
    let totalBarangAll = 0;
    let totalNilaiAll = 0;

    for (const data of Object.values(dataKecamatan)) {
      totalBarangAll += data.length;
      totalNilaiAll += data.reduce((a,b)=>a+b.nilai,0);
    }

    document.getElementById("grandSummary").innerHTML = `
      <h3>Rekap Total Semua Kecamatan</h3>
      <strong>Total Barang:</strong> ${totalBarangAll}<br>
      <strong>Total Nilai Perolehan:</strong> ${formatRupiah(totalNilaiAll)}
    `;
  }

  loadAllData();
</script>
</body>
</html>
