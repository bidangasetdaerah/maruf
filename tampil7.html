<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dashboard KIB B - DINAS PENDIDIKAN DAN KEBUDAYAAN</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<style>
body { font-family:sans-serif; margin:0; background:#f9fafb; transition:0.3s; }
header { position:fixed; top:0; left:0; right:0; background:#001f3f; color:white; padding:12px 15px; display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; z-index:1000; box-shadow:0 2px 6px rgba(0,0,0,0.2);}
header h1 { margin:0; font-size:1.1rem; }
header nav a { color:white; text-decoration:none; margin-right:10px; font-size:0.9rem;}
header nav a:hover { text-decoration:underline; }
.dark-toggle { background:none;border:none;color:white;font-size:1.4rem;cursor:pointer;}
main { padding-top:85px; min-height:80vh;}
footer { background:#001f3f;color:#f3f4f6;text-align:center;padding:15px 10px;font-size:0.85rem;}
h2 { font-size:1.2rem;margin-top:20px; }
h3 { font-size:1rem;margin-top:15px;color:#1f2937; }
.dashboard { display:flex; flex-wrap:wrap; gap:10px; margin-top:15px; padding:0 10px; }
.chart-container, table { background:white; border-radius:8px; padding:10px; box-shadow:0 2px 6px rgba(0,0,0,0.1); width:100%; }
.chart-container { flex:1 1 300px; }
canvas { width:100% !important; height:250px !important; }
table { width:100%; border-collapse:collapse; font-size:0.85rem; margin-top:10px; }
th, td { border:1px solid #ddd; padding:6px; text-align:left; }
th { background-color:#001f3f;color:white;font-size:0.8rem; }
.last-update { font-size:0.8rem;color:#555;margin-top:5px; }
.controls { margin:15px 10px; display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
input, select { padding:5px; border:1px solid #ccc; border-radius:5px; cursor:pointer; }
body.dark-mode { background:#111827; color:#f3f4f6; }
body.dark-mode header, body.dark-mode footer { background:#0a192f; }
body.dark-mode .chart-container, body.dark-mode table { background:#1f2937; color:#f3f4f6; }
body.dark-mode th { background-color:#0a192f; }
body.dark-mode td, body.dark-mode h3 { color:#f3f4f6; }
body.dark-mode .last-update { color:#d1d5db; }
button.expand-btn { background:#001f3f;color:white;border:none;padding:3px 6px;border-radius:4px;cursor:pointer;margin-right:5px; }
</style>
</head>
<body>

<header>
<div style="display:flex; align-items:center; gap:8px;">
<img src="https://upload.wikimedia.org/wikipedia/commons/e/e5/Lambang_Kabupaten_Donggala_%282015-sekarang%29.png" alt="Logo" style="height:32px;">
<h1>Dashboard KIB B</h1>
</div>
<div style="display:flex; align-items:center; gap:10px;">
<nav>
<a href="#rekapTable">Rekap</a>
<a href="#sekolahSection">Sekolah</a>
<a href="#about">Tentang</a>
</nav>
<button class="dark-toggle" onclick="toggleDarkMode()"><span id="darkIcon">🌙</span></button>
</div>
</header>

<main>
<h2 style="text-align:center;">DINAS PENDIDIKAN DAN KEBUDAYAAN</h2>

<div class="controls">
  <label><b>Filter Kecamatan:</b></label>
  <select id="filterKecamatan"><option value="all">Semua Kecamatan</option></select>
  <label><b>Cari Sekolah:</b></label>
  <input type="text" id="searchBox" placeholder="Ketik nama sekolah...">
  <label><b>Filter Kondisi:</b></label>
  <select id="filterKondisi">
    <option value="all">Semua</option>
    <option value="baik">Baik</option>
    <option value="rusak ringan">Rusak Ringan</option>
    <option value="rusak berat">Rusak Berat</option>
  </select>
</div>

<div class="dashboard">
<div class="chart-container"><h2>Rekap Konfirmasi Keberadaan</h2><canvas id="rekapKonfirmasi"></canvas></div>
<div class="chart-container"><h2>Rekap Kondisi Barang</h2><canvas id="rekapKondisi"></canvas></div>
<div class="chart-container"><h2>Rekap Nilai Perolehan</h2><canvas id="rekapNilai"></canvas></div>
</div>

<h2 style="padding-left:10px;">Rekap Per Kecamatan</h2>
<div id="lastUpdate" class="last-update" style="padding-left:10px;">Memuat data...</div>
<div style="padding: 0 10px;">
<table id="rekapTable">
<thead>
<tr>
<th>Kecamatan</th><th>Ditemukan</th><th>Tidak Ditemukan</th><th>Baik</th><th>Rusak Ringan</th><th>Rusak Berat</th><th>Nilai Perolehan</th>
</tr>
</thead>
<tbody></tbody>
<tfoot>
<tr style="font-weight:bold; background:#e5e7eb; color:black;">
<td>Total</td><td id="totalDitemukan">0</td><td id="totalTidakDitemukan">0</td><td id="totalBaik">0</td><td id="totalRusakRingan">0</td><td id="totalRusakBerat">0</td><td id="totalNilai">0</td>
</tr>
</tfoot>
</table>
</div>

<div id="sekolahSection" style="padding:10px;"></div>
</main>

<footer><p>&copy; 2025 DINAS PENDIDIKAN DAN KEBUDAYAAN - Sub Keuangan dan Aset.</p></footer>

<script>
// === Dark Mode Toggle ===
function toggleDarkMode(){
    document.body.classList.toggle('dark-mode');
    document.getElementById("darkIcon").textContent =
      document.body.classList.contains("dark-mode") ? "☀️" : "🌙";
}

// === Utility ===
function debounce(func, wait){ let timeout; return (...args)=>{ clearTimeout(timeout); timeout=setTimeout(()=>func(...args), wait); }; }

// === Parsing & Normalisasi ===
function parseNumberIndo(val){
    if(!val) return 0;
    val = val.toString().trim();
    val = val.replace(/Rp/gi, '').replace(/\s/g, '').replace(/[^0-9.,-]/g,'');
    if(val.includes('.') && val.includes(',')){
        if(val.lastIndexOf(',') > val.lastIndexOf('.')){
            val = val.replace(/\./g,'').replace(',', '.');
        } else {
            val = val.replace(/,/g,'');
        }
    } else if(val.includes(',')){
        val = val.replace(',', '.');
    } else {
        val = val.replace(/\./g,'');
    }
    return parseFloat(val) || 0;
}
function normalizeKondisi(val){
    if(!val) return "baik";
    val = val.toString().toLowerCase().trim().replace(/\s+/g," ");
    if(val.includes("rusak berat")||val==="rb"||val==="r berat") return "rusak berat";
    if(val.includes("rusak ringan")||val==="rr"||val==="r ringan") return "rusak ringan";
    if(val.includes("baik")||val==="b") return "baik";
    return "baik";
}
function formatRupiah(num){ return "Rp "+(num||0).toLocaleString("id-ID"); }

// === Endpoint CSV Kecamatan ===
const kecamatanEndpoints = {
  "Banawa": "URL_CSV_BANAWA",
  "Sojol": "URL_CSV_SOJOL",
  "Sojol Utara": "URL_CSV_SOJOL_UTARA",
  "Balaesang": "URL_CSV_BALAESANG"
};

// === Fetch CSV ===
async function fetchData(url){ return new Promise(resolve=>{ Papa.parse(url,{download:true,header:true,complete:res=>resolve(res.data)}); }); }

// === Load Data ===
let dataKecamatan = {}, chartKonfirmasi, chartKondisi, chartNilai;
async function loadAllData(){
    const promises = Object.entries(kecamatanEndpoints).map(async ([kec,url])=>{
        const raw = await fetchData(url);
        return [kec, raw.map(r=>({
            sekolah: (r["Nama Sekolah"] || r["Pengguna Barang"] || "").trim(),
            barang: r["Nama Barang"] || "",
            nibar: r["NIBAR"] || r["No. Register"] || "",
            konfirmasi: (r["Konfirmasi Keberadaan"] || "Tidak Ditemukan").toLowerCase().trim(),
            kondisi: normalizeKondisi(r["Kondisi"]),
            nilai: parseNumberIndo(r["Harga Perolehan"] || r["Nilai Perolehan"])
        }))];
    });
    const results = await Promise.all(promises);
    results.forEach(([kec,data])=>dataKecamatan[kec]=data);
    populateFilter(); updateData(); setInterval(updateData,300000);
}

// === Filter & Search ===
function populateFilter(){
    const filter = document.getElementById("filterKecamatan");
    Object.keys(dataKecamatan).forEach(k=>{ const opt=document.createElement("option"); opt.value=k; opt.textContent=k; filter.appendChild(opt); });
    filter.addEventListener("change", debounce(updateData,300));
    document.getElementById("searchBox").addEventListener("input", debounce(updateData,300));
    document.getElementById("filterKondisi").addEventListener("change", debounce(updateData,300));
}

// === Update Data ===
function updateData(){
    const filterKecamatan = document.getElementById("filterKecamatan").value;
    const filterKondisi = document.getElementById("filterKondisi").value;
    const search=document.getElementById("searchBox").value.toLowerCase();
    let total={Ditemukan:0,Tidak:0,Baik:0,Ringan:0,Berat:0,Nilai:0};
    let tbodyHTML="", sekolahHTML="";
    for(const [kec,data] of Object.entries(dataKecamatan)){
        if(filterKecamatan!=="all" && filterKecamatan!==kec) continue;
        let ditemukan=0,tidak=0,baik=0,ringan=0,berat=0,nilai=0;
        const sekolahMap={};
        data.forEach(r=>{
            if(search && !r.sekolah.toLowerCase().includes(search)) return;
            if(filterKondisi!=="all" && r.kondisi!==filterKondisi) return;
            if(r.konfirmasi==="ditemukan") ditemukan++; else tidak++;
            if(r.kondisi==="baik") baik++; else if(r.kondisi==="rusak ringan") ringan++; else if(r.kondisi==="rusak berat") berat++;
            nilai+=r.nilai;
            if(!sekolahMap[r.sekolah]) sekolahMap[r.sekolah]={barang:0,nilai:0,detail:[]};
            sekolahMap[r.sekolah].barang++; sekolahMap[r.sekolah].nilai+=r.nilai; sekolahMap[r.sekolah].detail.push(r);
        });
        total.Ditemukan+=ditemukan; total.Tidak+=tidak; total.Baik+=baik; total.Ringan+=ringan; total.Berat+=berat; total.Nilai+=nilai;
        tbodyHTML+=`<tr><td>${kec}</td><td>${ditemukan}</td><td>${tidak}</td><td>${baik}</td><td>${ringan}</td><td>${berat}</td><td>${formatRupiah(nilai)}</td></tr>`;
        sekolahHTML+=`<h3>Daftar Sekolah - ${kec}</h3><table><thead><tr><th>Nama Sekolah</th><th>Jumlah Barang</th><th>Nilai Perolehan</th></tr></thead><tbody>`;
        let idx=0;
        for(const [sName,val] of Object.entries(sekolahMap)){
            idx++; const detailId=`detail_${kec}_${idx}`;
            sekolahHTML+=`<tr><td><button class="expand-btn" onclick="toggleDetailLazy('${detailId}','${kec}','${sName}')">➕</button>${sName}</td><td>${val.barang}</td><td>${formatRupiah(val.nilai)}</td></tr><tr id="${detailId}" style="display:none;" data-loaded="false"><td colspan="3"></td></tr>`;
        }
        sekolahHTML+=`</tbody></table>`;
    }
    document.querySelector("#rekapTable tbody").innerHTML=tbodyHTML;
    document.getElementById("sekolahSection").innerHTML=sekolahHTML;
    document.getElementById("totalDitemukan").textContent=total.Ditemukan;
    document.getElementById("totalTidakDitemukan").textContent=total.Tidak;
    document.getElementById("totalBaik").textContent=total.Baik;
    document.getElementById("totalRusakRingan").textContent=total.Ringan;
    document.getElementById("totalRusakBerat").textContent=total.Berat;
    document.getElementById("totalNilai").textContent=formatRupiah(total.Nilai);
    document.getElementById("lastUpdate").textContent="Data terakhir diperbarui: "+new Date().toLocaleTimeString();
    updateCharts(total);
}

// === Update Charts ===
function updateCharts(total){
    const ctx1=document.getElementById("rekapKonfirmasi").getContext("2d");
    const ctx2=document.getElementById("rekapKondisi").getContext("2d");
    const ctx3=document.getElementById("rekapNilai").getContext("2d");
    if(chartKonfirmasi) chartKonfirmasi.destroy();
    if(chartKondisi) chartKondisi.destroy();
    if(chartNilai) chartNilai.destroy();
    chartKonfirmasi=new Chart(ctx1,{type:"pie",data:{labels:["Ditemukan","Tidak Ditemukan"],datasets:[{data:[total.Ditemukan,total.Tidak],backgroundColor:["#10b981","#ef4444"]}]}});
    chartKondisi=new Chart(ctx2,{type:"bar",data:{labels:["Baik","Rusak Ringan","Rusak Berat"],datasets:[{data:[total.Baik,total.Ringan,total.Berat],backgroundColor:["#3b82f6","#facc15","#f87171"]}]}});
    chartNilai=new Chart(ctx3,{type:"doughnut",data:{labels:["Total Nilai Barang"],datasets:[{data:[total.Nilai],backgroundColor:["#6366f1"]}]},options:{plugins:{tooltip:{callbacks:{label:ctx=>formatRupiah(ctx.raw)}}}}});
}

// === Lazy Loading Detail Sekolah ===
function toggleDetailLazy(id,kec,sekolah){
    const row=document.getElementById(id);
    const btn=row.previousElementSibling.querySelector("button");
    if(row.style.display==="none"){
        if(row.dataset.loaded!=="true"){
            const detailData = dataKecamatan[kec].filter(r=>r.sekolah===sekolah);
            let innerHTML=`<table style="width:100%; border:1px solid #ddd; font-size:0.8rem;"><thead><tr><th>Kecamatan</th><th>Nama Barang</th><th>NIBAR</th><th>Kondisi</th><th>Nilai</th></tr></thead><tbody>`;
            detailData.forEach(it=>{
                let bgColor=it.kondisi==="baik"?"#d1fae5":it.kondisi==="rusak ringan"?"#fef3c7":"#fee2e2";
                innerHTML+=`<tr style="background:${bgColor}"><td>${kec}</td><td>${it.barang}</td><td>${it.nibar}</td><td>${it.kondisi}</td><td>${formatRupiah(it.nilai)}</td></tr>`;
            });
            innerHTML+=`</tbody></table>`;
            row.children[0].innerHTML=innerHTML;
            row.dataset.loaded="true";
        }
        row.style.display="table-row"; btn.textContent="➖";
    } else { row.style.display="none"; btn.textContent="➕"; }
}

// === Start ===
loadAllData();
</script>

</body>
</html>
