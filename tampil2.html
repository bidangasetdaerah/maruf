<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Rekap Data Aset Sekolah</title>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.2/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.3.2/dist/chart.umd.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; background: #f4f6f8; }
    h2 { margin-top: 40px; }
    table { border-collapse: collapse; width: 100%; margin-top: 10px; }
    table, th, td { border: 1px solid #ccc; }
    th, td { padding: 8px; text-align: left; }
    .filter { margin-bottom: 20px; }
    .chart-container { width: 600px; margin: 20px auto; }
    .card { background: white; padding: 15px; margin: 10px 0; border-radius: 8px; box-shadow: 0 2px 6px rgba(0,0,0,0.1);}
  </style>
</head>
<body>
  <h1>Rekap Data Aset Sekolah per Kecamatan</h1>
  <div class="filter">
    <label for="kecamatanSelect">Pilih Kecamatan:</label>
    <select id="kecamatanSelect" onchange="updateData()"></select>
  </div>

  <div id="rekapContainer" class="card"></div>

  <div class="chart-container">
    <canvas id="chartKondisi"></canvas>
  </div>

  <div id="detailSekolah" class="card"></div>

<script>
const kecamatanEndpoints = {
  "Banawa": "https://docs.google.com/spreadsheets/d/e/2PACX-1vRd8vIhHDUbmD6I2aXLX7-_Ysemt2aXA__wKNGoKN0XWWSWCScv5aSmx06H0xkl8g/pub?gid=1917777904&single=true&output=csv",
  "Banawa Tengah": "https://docs.google.com/spreadsheets/d/e/2PACX-1vRnykw5e_i3dwBIeTua-mpFExEJ4w6hROJ5F6OUHiiGpbtunldeKgXlhN_G-D1V8w/pub?gid=1454720232&single=true&output=csv",
  "Banawa Selatan": "https://docs.google.com/spreadsheets/d/e/2PACX-1vRhDJK33BtCz7KEi6DWgqheZBrcdgK0X9Pw1r28u5ec1MK-I-kP-QOqrsY0G2OnEQ/pub?gid=708970016&single=true&output=csv",
  "Rio Pakava": "https://docs.google.com/spreadsheets/d/1_8YllqyTXGDZZCVeozFKAhGru2WS15Bp/export?format=csv",
  "Pinembani": "https://docs.google.com/spreadsheets/d/e/2PACX-1vQshgCYmG0DHxcwLUzhtUamXTYnWb8tR7WQwnJq9k7ldFz_JhV4GHDE-k_dMO_pSA/pub?gid=1860451546&single=true&output=csv",
  "Tanantovea": "https://docs.google.com/spreadsheets/d/e/2PACX-1vR3MhjBMD3q8UIfOTdAUOHKMdeGcwr3y2YQGFcDmHDd0IVsOsAECl511LsNJ9ynow9cmY4yBpP1jENa/pub?gid=1200528899&single=true&output=csv",
  "Labuan": "https://docs.google.com/spreadsheets/d/e/2PACX-1vT7WqNsmpUBIy0-lVm2JdGg1KUKwNgQPpbSyDuuFDwB1aGPY8gsZSBWmxIgiOeJNA/pub?gid=1615242439&single=true&output=csv",
  "Sindue": "https://docs.google.com/spreadsheets/d/e/2PACX-1vQ2sjcmJjTCYD3p6-7pDQTmm3mCVphZIP2-5DGZOHxStucexMcdqPVsfsbnDouFcA/pub?gid=1920885371&single=true&output=csv",
  "Sindue Tombusabora": "https://docs.google.com/spreadsheets/d/e/2PACX-1vRYHOyrOQ_hNjC1L1FoIMVbbWES0dPGb1OaU6V--PV_lm0O97IHFvtPRhgRNXn_dA/pub?gid=1974330298&single=true&output=csv",
  "Sindue Tobata": "https://docs.google.com/spreadsheets/d/e/2PACX-1vQIbvzs-jZRcf1z0uV_Ahwh6dNdBgBHw66T358D9wd0-DHimDs8r4ajCvZwLa8Srg/pub?gid=801352666&single=true&output=csv",
  "Sirenja": "https://docs.google.com/spreadsheets/d/e/2PACX-1vROhU6H6reNQxHKsAmYYgfcaSZyis1vALTmBkYhjAp7BGX_wNdA2cVdgOjFQIIgjQ/pub?output=csv",
  "Balaesang": "https://docs.google.com/spreadsheets/d/e/2PACX-1vQIf6mV6qgS6fmRe3jz305N8wCDdKWJcKKWSxHtybbo7xoERx15unD-x4rgyFxF-g/pub?gid=1401841928&single=true&output=csv",
  "Balaesang Tanjung": "https://docs.google.com/spreadsheets/d/e/2PACX-1vQRojLHXJ4W6IEdiNn34kZrMgr5QvPZllm85-sbgD0WxjG6vFMUMQz3QzzGnM-7pw/pub?gid=820099832&single=true&output=csv",
  "Dampelas": "https://docs.google.com/spreadsheets/d/e/2PACX-1vR_BmCgfv-HOMRKzNMZ1aHL05CZsR7Ie0VZGRJTD29tX1C-ANiKASW1hB_PM69WuQ/pub?gid=1489077321&single=true&output=csv",
  "Sojol": "https://docs.google.com/spreadsheets/d/e/2PACX-1vT64A3AbrmT4TK8fLj5ctUc3LLMESXVTOuw3nBd2qRTEFIljaxTBW3-Z5u4w7W2Ng/pub?gid=1781390946&single=true&output=csv",
  "Sojol Utara": "https://docs.google.com/spreadsheets/d/e/2PACX-1vT41KwECicPb2EY8d8BP1f73RM3dhVWYDOxpaFlHZluKFy9owLzyVX7N7mIUm37Tw/pub?gid=502544387&single=true&output=csv"
};

let dataKecamatan = {};
let chart;

async function fetchData(url){
  return new Promise((resolve,reject)=>{
    Papa.parse(url,{
      download:true,
      header:true,
      complete:res=>resolve(res.data),
      error:err=>reject(err)
    });
  });
}

function parseNumber(val){
  return parseFloat((val||"0").toString().replace(/[^0-9,.-]/g,"").replace(/\./g,"").replace(/,/g,".")) || 0;
}

async function loadAllData(){
  for(const [kec,url] of Object.entries(kecamatanEndpoints)){
    const rawData = await fetchData(url);
    dataKecamatan[kec] = rawData.map(r=>({
      sekolah: r["Nama Sekolah"] || r["Pengguna Barang"] || "",
      barang: r["Nama Barang"] || "",
      nibar: r["NIBAR"] || r["No. Register"] || "",
      konfirmasi: r["Konfirmasi Keberadaan"] || "Tidak Ditemukan",
      kondisiSebelumnya: r["Kondisi Sebelumnya"] || "",
      kondisiSaatIni: r["Kondisi Saat Ini"] || "",
      nilai: parseNumber(r["Harga Perolehan"] || r["Nilai Perolehan"])
    }));
  }
  populateFilter();
  updateData();
}

function populateFilter(){
  const select=document.getElementById("kecamatanSelect");
  select.innerHTML="";
  for(const kec of Object.keys(kecamatanEndpoints)){
    const opt=document.createElement("option");
    opt.value=kec; opt.textContent=kec;
    select.appendChild(opt);
  }
}

function updateData(){
  const kec=document.getElementById("kecamatanSelect").value;
  const data=dataKecamatan[kec]||[];
  let sekolahMap={};
  data.forEach(r=>{
    if(!sekolahMap[r.sekolah]){
      sekolahMap[r.sekolah]={barang:[],total:0,baik:0,ringan:0,berat:0};
    }
    sekolahMap[r.sekolah].barang.push(r);
    sekolahMap[r.sekolah].total++;
    if(r.kondisiSaatIni==="Baik") sekolahMap[r.sekolah].baik++;
    else if(r.kondisiSaatIni==="Rusak Ringan") sekolahMap[r.sekolah].ringan++;
    else if(r.kondisiSaatIni==="Rusak Berat") sekolahMap[r.sekolah].berat++;
  });
  let html="<h2>Rekap Kecamatan "+kec+"</h2>";
  html+="<table><thead><tr><th>Sekolah</th><th>Total Barang</th><th>Baik</th><th>Rusak Ringan</th><th>Rusak Berat</th></tr></thead><tbody>";
  let total=0,baik=0,ringan=0,berat=0;
  for(const [sekolah,info] of Object.entries(sekolahMap)){
    html+=`<tr onclick="showDetail('${kec}','${sekolah.replace(/'/g,"&#39;")}')"><td>${sekolah}</td><td>${info.total}</td><td>${info.baik}</td><td>${info.ringan}</td><td>${info.berat}</td></tr>`;
    total+=info.total;baik+=info.baik;ringan+=info.ringan;berat+=info.berat;
  }
  html+=`<tr><th>Total</th><th>${total}</th><th>${baik}</th><th>${ringan}</th><th>${berat}</th></tr>`;
  html+="</tbody></table>";
  document.getElementById("rekapContainer").innerHTML=html;
  updateChart(baik,ringan,berat);
  document.getElementById("detailSekolah").innerHTML="";
}

function updateChart(baik,ringan,berat){
  const ctx=document.getElementById("chartKondisi");
  if(chart) chart.destroy();
  chart=new Chart(ctx,{
    type:"pie",
    data:{
      labels:["Baik","Rusak Ringan","Rusak Berat"],
      datasets:[{data:[baik,ringan,berat]}]
    }
  });
}

function showDetail(kec,sekolah){
  const data=dataKecamatan[kec].filter(r=>r.sekolah===sekolah);
  let html=`<h3>Detail Barang - ${sekolah}</h3>`;
  html+="<table><thead><tr><th>Nama Barang</th><th>NIBAR</th><th>Kondisi Sebelumnya</th><th>Kondisi Saat Ini</th><th>Nilai Perolehan (Rp)</th></tr></thead><tbody>";
  for(const it of data){
    html+=`<tr><td>${it.barang}</td><td>${it.nibar}</td><td>${it.kondisiSebelumnya}</td><td>${it.kondisiSaatIni}</td><td>${it.nilai.toLocaleString("id-ID")}</td></tr>`;
  }
  html+="</tbody></table>";
  document.getElementById("detailSekolah").innerHTML=html;
}

loadAllData();
</script>
</body>
</html>
