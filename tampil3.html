<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Dashboard Aset Sekolah</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; padding: 10px; }
    h2 { margin-top: 20px; }
    table { border-collapse: collapse; width: 100%; margin-top: 10px; }
    th, td { border: 1px solid #999; padding: 6px; text-align: center; }
    .accordion-row { cursor: pointer; background: #f9f9f9; }
    .hidden { display: none; }
    .icon { font-weight: bold; text-align: center; }
    #chartFilter { margin: 10px 0; }
    #buttons { margin: 15px 0; }
    button { padding: 6px 12px; margin-right: 6px; cursor: pointer; }
  </style>
</head>
<body>

  <h2>Dashboard Aset Sekolah</h2>
  <select id="kecamatanSelect" onchange="showDetail(this.value)">
    <option value="">-- Pilih Kecamatan --</option>
    <option>Banawa</option>
    <option>Banawa Tengah</option>
    <option>Banawa Selatan</option>
    <option>Rio Pakava</option>
    <option>Pinembani</option>
    <option>Tanantovea</option>
    <option>Labuan</option>
    <option>Sindue</option>
    <option>Sindue Tombusabora</option>
    <option>Sindue Tobata</option>
    <option>Sirenja</option>
    <option>Balaesang</option>
    <option>Balaesang Tanjung</option>
    <option>Dampelas</option>
    <option>Sojol</option>
    <option>Sojol Utara</option>
  </select>

  <div id="buttons" class="hidden">
    <button onclick="exportExcel()">ðŸ“Š Export Excel</button>
    <button onclick="exportPDF()">ðŸ“„ Export PDF</button>
  </div>

  <div id="detail"></div>

  <script>
  // Contoh data dummy, ganti dengan hasil fetch dari Google Sheet
  const dataKecamatan = {
    "Banawa": "https://docs.google.com/spreadsheets/d/e/2PACX-1vRd8vIhHDUbmD6I2aXLX7-_Ysemt2aXA__wKNGoKN0XWWSWCScv5aSmx06H0xkl8g/pub?gid=1917777904&single=true&output=csv",
    "Banawa Tengah": "https://docs.google.com/spreadsheets/d/e/2PACX-1vRnykw5e_i3dwBIeTua-mpFExEJ4w6hROJ5F6OUHiiGpbtunldeKgXlhN_G-D1V8w/pub?gid=1454720232&single=true&output=csv",
    "Banawa Selatan": "https://docs.google.com/spreadsheets/d/e/2PACX-1vRhDJK33BtCz7KEi6DWgqheZBrcdgK0X9Pw1r28u5ec1MK-I-kP-QOqrsY0G2OnEQ/pub?gid=708970016&single=true&output=csv",
    "Rio Pakava": "https://docs.google.com/spreadsheets/d/1_8YllqyTXGDZZCVeozFKAhGru2WS15Bp/export?format=csv",
    "Pinembani": "https://docs.google.com/spreadsheets/d/e/2PACX-1vQshgCYmG0DHxcwLUzhtUamXTYnWb8tR7WQwnJq9k7ldFz_JhV4GHDE-k_dMO_pSA/pub?gid=1860451546&single=true&output=csv",
    "Tanantovea": "https://docs.google.com/spreadsheets/d/e/2PACX-1vR3MhjBMD3q8UIfOTdAUOHKMdeGcwr3y2YQGFcDmHDd0IVsOsAECl511LsNJ9ynow9cmY4yBpP1jENa/pub?gid=1200528899&single=true&output=csv",
    "Labuan": "https://docs.google.com/spreadsheets/d/e/2PACX-1vT7WqNsmpUBIy0-lVm2JdGg1KUKwNgQPpbSyDuuFDwB1aGPY8gsZSBWmxIgiOeJNA/pub?gid=1615242439&single=true&output=csv",
    "Sindue": "https://docs.google.com/spreadsheets/d/e/2PACX-1vQ2sjcmJjTCYD3p6-7pDQTmm3mCVphZIP2-5DGZOHxStucexMcdqPVsfsbnDouFcA/pub?gid=1920885371&single=true&output=csv",
    "Sindue Tombusabora": "https://docs.google.com/spreadsheets/d/e/2PACX-1vRYHOyrOQ_hNjC1L1FoIMVbbWES0dPGb1OaU6V--PV_lm0O97IHFvtPRhgRNXn_dA/pub?gid=1974330298&single=true&output=csv",
    "Sindue Tobata": "https://docs.google.com/spreadsheets/d/e/2PACX-1vQIbvzs-jZRcf1z0uV_Ahwh6dNdBgBHw66T358D9wd0-DHimDs8r4ajCvZwLa8Srg/pub?gid=801352666&single=true&output=csv",
    "Sirenja": "https://docs.google.com/spreadsheets/d/e/2PACX-1vROhU6H6reNQxHKsAmYYgfcaSZyis1vALTmBkYhjAp7BGX_wNdA2cVdgOjFQIIgjQ/pub?output=csv",
    "Balaesang": "https://docs.google.com/spreadsheets/d/e/2PACX-1vQIf6mV6qgS6fmRe3jz305N8wCDdKWJcKKWSxHtybbo7xoERx15unD-x4rgyFxF-g/pub?gid=1401841928&single=true&output=csv",
    "Balaesang Tanjung": "https://docs.google.com/spreadsheets/d/e/2PACX-1vQRojLHXJ4W6IEdiNn34kZrMgr5QvPZllm85-sbgD0WxjG6vFMUMQz3QzzGnM-7pw/pub?gid=820099832&single=true&output=csv",
    "Dampelas": "https://docs.google.com/spreadsheets/d/e/2PACX-1vR_BmCgfv-HOMRKzNMZ1aHL05CZsR7Ie0VZGRJTD29tX1C-ANiKASW1hB_PM69WuQ/pub?gid=1489077321&single=true&output=csv",
    "Sojol": "https://docs.google.com/spreadsheets/d/e/2PACX-1vT64A3AbrmT4TK8fLj5ctUc3LLMESXVTOuw3nBd2qRTEFIljaxTBW3-Z5u4w7W2Ng/pub?gid=1781390946&single=true&output=csv",
    "Sojol Utara": "https://docs.google.com/spreadsheets/d/e/2PACX-1vT41KwECicPb2EY8d8BP1f73RM3dhVWYDOxpaFlHZluKFy9owLzyVX7N7mIUm37Tw/pub?gid=502544387&single=true&output=csv"
  };

  let chartInstance=null;
  let schoolChartInstance=null;
  let schoolChartData={labels:[],baik:[],ringan:[],berat:[]};

  function toggleRows(id){
    const row=document.getElementById(id);
    const icon=document.getElementById("icon-"+id);
    if(row.classList.contains("hidden")){
      row.classList.remove("hidden");
      icon.textContent="-";
    } else {
      row.classList.add("hidden");
      icon.textContent="+";
    }
  }

  function showDetail(kec){
    const detailDiv=document.getElementById("detail");
    if(!kec || !dataKecamatan[kec]){ detailDiv.innerHTML=""; document.getElementById("buttons").classList.add("hidden"); return; }
    const list=dataKecamatan[kec];
    const sekolahMap={};
    list.forEach(r=>{
      if(!sekolahMap[r.sekolah]) sekolahMap[r.sekolah]=[];
      sekolahMap[r.sekolah].push(r);
    });

    // Hitung subtotal kecamatan
    let totalBarang=0, totalBaik=0, totalRingan=0, totalBerat=0, totalNilai=0;
    list.forEach(r=>{
      totalBarang++;
      if(r.kondisiSaatIni==="Baik") totalBaik++;
      else if(r.kondisiSaatIni==="Rusak Ringan") totalRingan++;
      else if(r.kondisiSaatIni==="Rusak Berat") totalBerat++;
      totalNilai+=r.nilai;
    });

    let html=`<h3>${kec}</h3>
      <h4>Subtotal Kecamatan</h4>
      <table>
        <tr>
          <th>Jumlah Barang</th><th>Baik</th><th>Rusak Ringan</th><th>Rusak Berat</th><th>Total Nilai (Rp)</th>
        </tr>
        <tr>
          <td>${totalBarang}</td>
          <td>${totalBaik}</td>
          <td>${totalRingan}</td>
          <td>${totalBerat}</td>
          <td>${totalNilai.toLocaleString("id-ID")}</td>
        </tr>
      </table>
      <br/>
      <canvas id="kecChart" width="300" height="300"></canvas>
      <br/>
      <div id="chartFilter">
        <label><input type="checkbox" value="Baik" checked onchange="updateSchoolChart()"> Baik</label>
        <label><input type="checkbox" value="Rusak Ringan" checked onchange="updateSchoolChart()"> Rusak Ringan</label>
        <label><input type="checkbox" value="Rusak Berat" checked onchange="updateSchoolChart()"> Rusak Berat</label>
      </div>
      <canvas id="schoolChart" width="600" height="300"></canvas>
      <br/>
      <h4>Rincian per Sekolah</h4>
      <table>
        <tr>
          <th></th><th>Sekolah</th><th>Jumlah Barang</th>
          <th>Baik</th><th>Rusak Ringan</th><th>Rusak Berat</th>
          <th>Total Nilai (Rp)</th>
        </tr>`;

    let i=0;
    let sekolahLabels=[], baikArr=[], ringanArr=[], beratArr=[];

    for(const [sekolah,items] of Object.entries(sekolahMap)){
      let baik=0, ringan=0, berat=0, totalNilaiSekolah=0;
      items.forEach(r=>{
        if(r.kondisiSaatIni==="Baik") baik++;
        else if(r.kondisiSaatIni==="Rusak Ringan") ringan++;
        else if(r.kondisiSaatIni==="Rusak Berat") berat++;
        totalNilaiSekolah+=r.nilai;
      });

      sekolahLabels.push(sekolah);
      baikArr.push(baik);
      ringanArr.push(ringan);
      beratArr.push(berat);

      html+=`
        <tr class="accordion-row" onclick="toggleRows('s${i}')">
          <td class="icon" id="icon-s${i}">+</td>
          <td>${sekolah}</td>
          <td>${items.length}</td>
          <td>${baik}</td>
          <td>${ringan}</td>
          <td>${berat}</td>
          <td>${totalNilaiSekolah.toLocaleString("id-ID")}</td>
        </tr>
        <tr id="s${i}" class="hidden">
          <td colspan="7">
            <table>
              <tr>
                <th>Nama Barang</th><th>NIBAR</th>
                <th>Kondisi Sebelumnya</th><th>Kondisi Saat Ini</th>
                <th>Nilai Perolehan (Rp)</th>
              </tr>
              ${items.map(r=>`
                <tr>
                  <td>${r.barang}</td>
                  <td>${r.nibar}</td>
                  <td>${r.kondisiSebelumnya}</td>
                  <td>${r.kondisiSaatIni}</td>
                  <td>${r.nilai.toLocaleString("id-ID")}</td>
                </tr>`).join("")}
            </table>
          </td>
        </tr>
      `;
      i++;
    }
    html+="</table>";
    detailDiv.innerHTML=html;

    // tampilkan tombol export
    document.getElementById("buttons").classList.remove("hidden");

    // Chart Pie Kecamatan
    const ctx=document.getElementById("kecChart").getContext("2d");
    if(chartInstance) chartInstance.destroy();
    chartInstance=new Chart(ctx,{
      type:"pie",
      data:{labels:["Baik","Rusak Ringan","Rusak Berat"],
        datasets:[{data:[totalBaik,totalRingan,totalBerat],
          backgroundColor:["#4CAF50","#FFC107","#F44336"]}]},
      options:{responsive:false,plugins:{legend:{position:"bottom"},title:{display:true,text:"Kondisi Barang di "+kec}}}
    });

    // simpan data untuk chart sekolah
    schoolChartData={labels:sekolahLabels,baik:baikArr,ringan:ringanArr,berat:beratArr};
    updateSchoolChart();
  }

  function updateSchoolChart(){
    const checked=Array.from(document.querySelectorAll("#chartFilter input:checked")).map(cb=>cb.value);
    const datasets=[];
    if(checked.includes("Baik")) datasets.push({label:"Baik",data:schoolChartData.baik,backgroundColor:"#4CAF50"});
    if(checked.includes("Rusak Ringan")) datasets.push({label:"Rusak Ringan",data:schoolChartData.ringan,backgroundColor:"#FFC107"});
    if(checked.includes("Rusak Berat")) datasets.push({label:"Rusak Berat",data:schoolChartData.berat,backgroundColor:"#F44336"});
    const ctx2=document.getElementById("schoolChart").getContext("2d");
    if(schoolChartInstance) schoolChartInstance.destroy();
    schoolChartInstance=new Chart(ctx2,{
      type:"bar",
      data:{labels:schoolChartData.labels,datasets:datasets},
      options:{responsive:true,scales:{x:{stacked:true},y:{stacked:true,beginAtZero:true}},
      plugins:{title:{display:true,text:"Perbandingan Kondisi Barang per Sekolah"}}}
    });
  }

  function exportExcel(){
    const kec=document.getElementById("kecamatanSelect").value;
    if(!kec) return;
    const list=dataKecamatan[kec];
    const ws_data=[["Sekolah","Nama Barang","NIBAR","Kondisi Sebelumnya","Kondisi Saat Ini","Nilai"]];
    list.forEach(r=>{
      ws_data.push([r.sekolah,r.barang,r.nibar,r.kondisiSebelumnya,r.kondisiSaatIni,r.nilai]);
    });
    const ws=XLSX.utils.aoa_to_sheet(ws_data);
    const wb=XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb,ws,kec);
    XLSX.writeFile(wb,`Aset_${kec}.xlsx`);
  }

  async function exportPDF(){
    const { jsPDF } = window.jspdf;
    const kec=document.getElementById("kecamatanSelect").value;
    if(!kec) return;
    const list=dataKecamatan[kec];
    const doc=new jsPDF();
    doc.text(`Rekap Aset Sekolah Kecamatan ${kec}`,14,15);
    const rows=list.map(r=>[r.sekolah,r.barang,r.nibar,r.kondisiSebelumnya,r.kondisiSaatIni,r.nilai.toLocaleString("id-ID")]);
    doc.autoTable({
      head:[["Sekolah","Barang","NIBAR","Kondisi Sebelumnya","Kondisi Saat Ini","Nilai"]],
      body:rows,
      startY:20
    });
    doc.save(`Aset_${kec}.pdf`);
  }
  </script>
</body>
</html>
