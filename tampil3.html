<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Dashboard Aset Sekolah</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.19.3/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="p-6 bg-gray-100 text-gray-800">
  <h2 class="text-2xl font-bold mb-4">ðŸ“Š Dashboard Aset Sekolah</h2>

  <div class="mb-4">
    <label class="font-semibold">Pilih Kecamatan:</label>
    <select id="kecamatanSelect" onchange="showDetail(this.value)" 
      class="p-2 border rounded w-full md:w-1/2">
      <option value="">-- Pilih Kecamatan --</option>
    </select>
  </div>

  <div id="buttons" class="hidden space-x-2 mb-4">
    <button onclick="exportExcel()" class="bg-green-600 text-white px-4 py-2 rounded shadow">ðŸ“Š Export Excel</button>
    <button onclick="exportPDF()" class="bg-red-600 text-white px-4 py-2 rounded shadow">ðŸ“„ Export PDF</button>
  </div>

  <!-- Loading spinner -->
  <div id="loading" class="hidden text-center my-4">
    <div class="animate-spin border-4 border-blue-300 border-t-blue-600 rounded-full w-8 h-8 mx-auto"></div>
    <p class="mt-2 font-semibold">Sedang memuat data...</p>
  </div>

  <!-- Rekap Kabupaten -->
  <div class="bg-white p-4 rounded shadow mb-6">
    <h3 class="text-lg font-bold mb-2">Rekap Keseluruhan Kabupaten</h3>
    <div id="kabupatenSummaryText" class="mb-4 text-sm font-semibold text-gray-700"></div>
    <canvas id="kabupatenChart" class="w-full max-h-80"></canvas>
  </div>

  <!-- Rekap antar Kecamatan -->
  <div class="bg-white p-4 rounded shadow mb-6">
    <h3 class="text-lg font-bold mb-2">Perbandingan Antar Kecamatan</h3>
    <canvas id="kecamatanChart" class="w-full max-h-96"></canvas>
  </div>

  <div id="detail" class="bg-white p-4 rounded shadow"></div>

<script>
const dataKecamatan = {
  "Banawa": "https://docs.google.com/spreadsheets/d/e/2PACX-1vRd8vIhHDUbmD6I2aXLX7-_Ysemt2aXA__wKNGoKN0XWWSWCScv5aSmx06H0xkl8g/pub?gid=1917777904&single=true&output=csv",
    "Banawa Tengah": "https://docs.google.com/spreadsheets/d/e/2PACX-1vRnykw5e_i3dwBIeTua-mpFExEJ4w6hROJ5F6OUHiiGpbtunldeKgXlhN_G-D1V8w/pub?gid=1454720232&single=true&output=csv",
    "Banawa Selatan": "https://docs.google.com/spreadsheets/d/e/2PACX-1vRhDJK33BtCz7KEi6DWgqheZBrcdgK0X9Pw1r28u5ec1MK-I-kP-QOqrsY0G2OnEQ/pub?gid=708970016&single=true&output=csv",
    "Rio Pakava": "https://docs.google.com/spreadsheets/d/1_8YllqyTXGDZZCVeozFKAhGru2WS15Bp/export?format=csv",
    "Pinembani": "https://docs.google.com/spreadsheets/d/e/2PACX-1vQshgCYmG0DHxcwLUzhtUamXTYnWb8tR7WQwnJq9k7ldFz_JhV4GHDE-k_dMO_pSA/pub?gid=1860451546&single=true&output=csv",
    "Tanantovea": "https://docs.google.com/spreadsheets/d/e/2PACX-1vR3MhjBMD3q8UIfOTdAUOHKMdeGcwr3y2YQGFcDmHDd0IVsOsAECl511LsNJ9ynow9cmY4yBpP1jENa/pub?gid=1200528899&single=true&output=csv",
    "Labuan": "https://docs.google.com/spreadsheets/d/e/2PACX-1vT7WqNsmpUBIy0-lVm2JdGg1KUKwNgQPpbSyDuuFDwB1aGPY8gsZSBWmxIgiOeJNA/pub?gid=1615242439&single=true&output=csv",
    "Sindue": "https://docs.google.com/spreadsheets/d/e/2PACX-1vQ2sjcmJjTCYD3p6-7pDQTmm3mCVphZIP2-5DGZOHxStucexMcdqPVsfsbnDouFcA/pub?gid=1920885371&single=true&output=csv",
    "Sindue Tombusabora": "https://docs.google.com/spreadsheets/d/e/2PACX-1vRYHOyrOQ_hNjC1L1FoIMVbbWES0dPGb1OaU6V--PV_lm0O97IHFvtPRhgRNXn_dA/pub?gid=1974330298&single=true&output=csv",
    "Sindue Tobata": "https://docs.google.com/spreadsheets/d/e/2PACX-1vQIbvzs-jZRcf1z0uV_Ahwh6dNdBgBHw66T358D9wd0-DHimDs8r4ajCvZwLa8Srg/pub?gid=801352666&single=true&output=csv",
    "Sirenja": "https://docs.google.com/spreadsheets/d/e/2PACX-1vROhU6H6reNQxHKsAmYYgfcaSZyis1vALTmBkYhjAp7BGX_wNdA2cVdgOjFQIIgjQ/pub?output=csv",
    "Balaesang": "https://docs.google.com/spreadsheets/d/e/2PACX-1vQIf6mV6qgS6fmRe3jz305N8wCDdKWJcKKWSxHtybbo7xoERx15unD-x4rgyFxF-g/pub?gid=1401841928&single=true&output=csv",
    "Balaesang Tanjung": "https://docs.google.com/spreadsheets/d/e/2PACX-1vQRojLHXJ4W6IEdiNn34kZrMgr5QvPZllm85-sbgD0WxjG6vFMUMQz3QzzGnM-7pw/pub?gid=820099832&single=true&output=csv",
    "Dampelas": "https://docs.google.com/spreadsheets/d/e/2PACX-1vR_BmCgfv-HOMRKzNMZ1aHL05CZsR7Ie0VZGRJTD29tX1C-ANiKASW1hB_PM69WuQ/pub?gid=1489077321&single=true&output=csv",
    "Sojol": "https://docs.google.com/spreadsheets/d/e/2PACX-1vT64A3AbrmT4TK8fLj5ctUc3LLMESXVTOuw3nBd2qRTEFIljaxTBW3-Z5u4w7W2Ng/pub?gid=1781390946&single=true&output=csv",
    "Sojol Utara": "https://docs.google.com/spreadsheets/d/e/2PACX-1vT41KwECicPb2EY8d8BP1f73RM3dhVWYDOxpaFlHZluKFy9owLzyVX7N7mIUm37Tw/pub?gid=502544387&single=true&output=csv"
};

let kabupatenSummary = { sekolah: new Set(), baik:0, ringan:0, berat:0 };
let perKecamatanSummary = {};
let kabupatenChart = null;
let kecamatanChart = null;
let sekolahCharts = {}; // simpan chart per sekolah

// isi dropdown otomatis
window.onload = async function(){
  const select=document.getElementById("kecamatanSelect");
  Object.keys(dataKecamatan).forEach(kec=>{
    const opt=document.createElement("option");
    opt.value=kec; opt.textContent=kec;
    select.appendChild(opt);
  });

  for(const kec in dataKecamatan){
    await fetchDataKecamatan(kec,false);
  }
  renderKabupatenSummary();
  renderKabupatenChart();
  renderKecamatanChart();
};

// ambil data & bersihkan kolom kondisi + nilai
async function fetchDataKecamatan(kec, render=true){
  try {
    const response=await fetch(dataKecamatan[kec]);
    const csvText=await response.text();
    const parsed=Papa.parse(csvText,{header:true,skipEmptyLines:true});
    const list=parsed.data.map(r=>{
      const kondisiSaatIni = r["Kondisi Saat Ini"] || r["Kondisi"] || r["Kondisi Aset"] || r["Kondisi Sekarang"] || r["Kondisi Terakhir"];
      const nilai = r["Nilai Perolehan (Rp)"] || r["Nilai Perolehan"] || r["Harga Perolehan"] || r["Nilai"] || "0";
      return {
        sekolah: r["Pengguna Barang"] || r["Sekolah"] || "Tidak Diketahui",
        barang: r["Nama Barang"] || "-",
        nibar: r["NIBAR"] || "-",
        kondisiSebelumnya: r["Kondisi Sebelumnya"] || "-",
        kondisiSaatIni: kondisiSaatIni || "-",
        nilai: parseInt(nilai.replace(/[^0-9]/g,"")) || 0
      };
    });

    // Hitung ringkasan kabupaten
    list.forEach(r=>{
      kabupatenSummary.sekolah.add(r.sekolah);
      if(r.kondisiSaatIni==="Baik") kabupatenSummary.baik++;
      else if(r.kondisiSaatIni==="Rusak Ringan") kabupatenSummary.ringan++;
      else if(r.kondisiSaatIni==="Rusak Berat") kabupatenSummary.berat++;
    });

    // Ringkasan per kecamatan
    if(!perKecamatanSummary[kec]) perKecamatanSummary[kec]={baik:0,ringan:0,berat:0};
    list.forEach(r=>{
      if(r.kondisiSaatIni==="Baik") perKecamatanSummary[kec].baik++;
      else if(r.kondisiSaatIni==="Rusak Ringan") perKecamatanSummary[kec].ringan++;
      else if(r.kondisiSaatIni==="Rusak Berat") perKecamatanSummary[kec].berat++;
    });

    if(render) renderDetail(kec,list);
  } catch(err){ console.error(err); }
}

function renderKabupatenSummary(){
  const div=document.getElementById("kabupatenSummaryText");
  div.innerHTML=`
    Total Sekolah: ${kabupatenSummary.sekolah.size} <br>
    Total Baik: ${kabupatenSummary.baik} <br>
    Total Rusak Ringan: ${kabupatenSummary.ringan} <br>
    Total Rusak Berat: ${kabupatenSummary.berat}
  `;
}

function renderKabupatenChart(){
  const ctx=document.getElementById("kabupatenChart");
  if(kabupatenChart) kabupatenChart.destroy();
  kabupatenChart=new Chart(ctx,{
    type:"pie",
    data:{labels:["Baik","Rusak Ringan","Rusak Berat"],
      datasets:[{ data:[kabupatenSummary.baik,kabupatenSummary.ringan,kabupatenSummary.berat],
      backgroundColor:["#4CAF50","#FFC107","#F44336"] }]}
  });
}

function renderKecamatanChart(){
  const ctx=document.getElementById("kecamatanChart");
  if(kecamatanChart) kecamatanChart.destroy();
  kecamatanChart=new Chart(ctx,{
    type:"bar",
    data:{
      labels:Object.keys(perKecamatanSummary),
      datasets:[
        {label:"Baik", data:Object.values(perKecamatanSummary).map(v=>v.baik), backgroundColor:"#4CAF50"},
        {label:"Rusak Ringan", data:Object.values(perKecamatanSummary).map(v=>v.ringan), backgroundColor:"#FFC107"},
        {label:"Rusak Berat", data:Object.values(perKecamatanSummary).map(v=>v.berat), backgroundColor:"#F44336"}
      ]
    },
    options:{responsive:true,plugins:{legend:{position:"bottom"}},scales:{x:{stacked:true},y:{stacked:true,beginAtZero:true}}}
  });
}

async function showDetail(kec){
  const detailDiv=document.getElementById("detail");
  const loading=document.getElementById("loading");
  if(!kec || !dataKecamatan[kec]){
    detailDiv.innerHTML="";
    document.getElementById("buttons").classList.add("hidden");
    return;
  }
  loading.classList.remove("hidden");
  detailDiv.innerHTML="";
  await fetchDataKecamatan(kec,true);
  loading.classList.add("hidden");
}

function renderDetail(kec,list){
  const detailDiv=document.getElementById("detail");
  document.getElementById("buttons").classList.remove("hidden");

  const sekolahMap={};
  list.forEach(r=>{
    if(!sekolahMap[r.sekolah]) sekolahMap[r.sekolah]=[];
    sekolahMap[r.sekolah].push(r);
  });

  detailDiv.innerHTML=`<h3 class="text-lg font-bold mb-4">Detail Kecamatan ${kec}</h3>`;
  for(const sekolah in sekolahMap){
    const items=sekolahMap[sekolah];
    const totalNilai=items.reduce((sum,x)=>sum+x.nilai,0);

    // hitung kondisi untuk chart sekolah
    const counts={Baik:0,"Rusak Ringan":0,"Rusak Berat":0};
    items.forEach(x=>{
      if(counts[x.kondisiSaatIni]!==undefined) counts[x.kondisiSaatIni]++;
    });

    let rows="";
    items.forEach(x=>{
      rows+=`<tr class="border-b">
        <td class="p-2">${x.barang}</td>
        <td class="p-2">${x.nibar}</td>
        <td class="p-2">${x.kondisiSebelumnya}</td>
        <td class="p-2">${x.kondisiSaatIni}</td>
        <td class="p-2 text-right">${x.nilai.toLocaleString("id-ID")}</td>
      </tr>`;
    });

    const chartId="chart_"+sekolah.replace(/\s+/g,"_");

    detailDiv.innerHTML+=`
      <div class="mb-6 border rounded-lg shadow p-4 bg-gray-50">
        <button onclick="toggleSekolah('${chartId}','${sekolah}')" class="font-semibold text-blue-700 flex items-center">
          âž• ${sekolah}
        </button>
        <div id="${chartId}" class="hidden mt-2">
          <canvas id="${chartId}_canvas" class="w-full max-h-64 mb-4"></canvas>
          <table class="w-full border text-sm">
            <thead class="bg-gray-200">
              <tr>
                <th class="p-2">Nama Barang</th>
                <th class="p-2">NIBAR</th>
                <th class="p-2">Kondisi Sebelumnya</th>
                <th class="p-2">Kondisi Saat Ini</th>
                <th class="p-2">Nilai Perolehan (Rp)</th>
              </tr>
            </thead>
            <tbody>${rows}</tbody>
          </table>
          <p class="mt-2 font-semibold">Total Nilai: Rp ${totalNilai.toLocaleString("id-ID")}</p>
        </div>
      </div>
    `;

    // simpan data untuk chart
    sekolahCharts[chartId]={counts,rendered:false};
  }
}

function toggleSekolah(chartId,sekolah){
  const div=document.getElementById(chartId);
  div.classList.toggle("hidden");
  if(!div.classList.contains("hidden") && !sekolahCharts[chartId].rendered){
    const ctx=document.getElementById(chartId+"_canvas");
    const {counts}=sekolahCharts[chartId];
    new Chart(ctx,{
      type:"pie",
      data:{
        labels:["Baik","Rusak Ringan","Rusak Berat"],
        datasets:[{
          data:[counts["Baik"],counts["Rusak Ringan"],counts["Rusak Berat"]],
          backgroundColor:["#4CAF50","#FFC107","#F44336"]
        }]
      },
      options:{plugins:{title:{display:true,text:`Kondisi Aset ${sekolah}`}}}
    });
    sekolahCharts[chartId].rendered=true;
  }
}
</script>
</body>
</html>
