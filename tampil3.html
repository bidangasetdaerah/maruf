<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <title>Dashboard Rekap Data Kecamatan</title>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.19.3/xlsx.full.min.js"></script>
  <style>
    body{font-family:Arial, sans-serif;margin:20px;}
    label{margin-right:8px;}
    select{margin-right:16px;padding:6px;}
    button{padding:8px 12px;margin:8px 0;}
    table{border-collapse:collapse;width:100%;margin:16px 0;}
    th,td{border:1px solid #ccc;padding:8px;text-align:left;}
    th{background:#f5f5f5;}
    .wrap{display:flex;flex-wrap:wrap;gap:16px;}
    .chart-card{flex:1 1 420px;max-width:620px;padding:12px;border:1px solid #e5e5e5;border-radius:8px;background:#fafafa;}
    .summary-box{padding:12px;border:1px solid #e5e5e5;border-radius:8px;background:#fbfbfb;margin:12px 0;}
    .summary-row{display:flex;flex-wrap:wrap;gap:16px}
    .summary-item{min-width:220px}
    .muted{color:#666;font-size:12px;margin-top:-6px}
  </style>
</head>
<body>
  <h1>Dashboard Rekap Data Kecamatan</h1>

  <div>
    <label for="filterKecamatan">Pilih Kecamatan:</label>
    <select id="filterKecamatan" onchange="updateSekolahFilter()"></select>

    <label for="filterSekolah">Pilih Sekolah:</label>
    <select id="filterSekolah" onchange="updateData()"></select>

    <button onclick="exportExcel()">ðŸ“¥ Export Excel</button>
    <div class="muted">Jika memilih sekolah, yang diekspor adalah detail barang sekolah tersebut. Jika tidak, tabel rekap kecamatan yang diekspor.</div>
  </div>

  <div id="summaryKabupaten" class="summary-box"></div>

  <h2>Rekap Data Kecamatan</h2>
  <table id="rekapTable">
    <thead>
      <tr>
        <th rowspan="2">Kecamatan</th>
        <th rowspan="2">Jumlah Sekolah</th>
        <th rowspan="2">Jumlah Barang</th>
        <th rowspan="2">Nilai Total (Rp)</th>
        <th colspan="3">Kondisi Sebelumnya</th>
        <th colspan="3">Kondisi Saat Ini</th>
      </tr>
      <tr>
        <th>Baik</th><th>Rusak Ringan</th><th>Rusak Berat</th>
        <th>Baik</th><th>Rusak Ringan</th><th>Rusak Berat</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <div class="wrap">
    <div class="chart-card">
      <h3>Pie â€“ Rekap Kondisi Saat Ini (Kabupaten)</h3>
      <canvas id="chartKondisi"></canvas>
    </div>
    <div class="chart-card">
      <h3>Bar â€“ Rekap per Kecamatan (Kondisi Saat Ini)</h3>
      <canvas id="chartSummary"></canvas>
    </div>
  </div>

  <h2>Detail Sekolah</h2>
  <div id="detailSekolah"></div>

<script>
/* ================== Konfigurasi sumber data ================== */
const kecamatanEndpoints = {
  "Banawa": "https://docs.google.com/spreadsheets/d/e/2PACX-1vRd8vIhHDUbmD6I2aXLX7-_Ysemt2aXA__wKNGoKN0XWWSWCScv5aSmx06H0xkl8g/pub?gid=1917777904&single=true&output=csv",
  "Banawa Tengah": "https://docs.google.com/spreadsheets/d/e/2PACX-1vRnykw5e_i3dwBIeTua-mpFExEJ4w6hROJ5F6OUHiiGpbtunldeKgXlhN_G-D1V8w/pub?gid=1454720232&single=true&output=csv",
  "Banawa Selatan": "https://docs.google.com/spreadsheets/d/e/2PACX-1vRhDJK33BtCz7KEi6DWgqheZBrcdgK0X9Pw1r28u5ec1MK-I-kP-QOqrsY0G2OnEQ/pub?gid=708970016&single=true&output=csv",
  "Rio Pakava": "https://docs.google.com/spreadsheets/d/1_8YllqyTXGDZZCVeozFKAhGru2WS15Bp/export?format=csv",
  "Pinembani": "https://docs.google.com/spreadsheets/d/e/2PACX-1vQshgCYmG0DHxcwLUzhtUamXTYnWb8tR7WQwnJq9k7ldFz_JhV4GHDE-k_dMO_pSA/pub?gid=1860451546&single=true&output=csv",
  "Tanantovea": "https://docs.google.com/spreadsheets/d/e/2PACX-1vR3MhjBMD3q8UIfOTdAUOHKMdeGcwr3y2YQGFcDmHDd0IVsOsAECl511LsNJ9ynow9cmY4yBpP1jENa/pub?gid=1200528899&single=true&output=csv",
  "Labuan": "https://docs.google.com/spreadsheets/d/e/2PACX-1vT7WqNsmpUBIy0-lVm2JdGg1KUKwNgQPpbSyDuuFDwB1aGPY8gsZSBWmxIgiOeJNA/pub?gid=1615242439&single=true&output=csv",
  "Sindue": "https://docs.google.com/spreadsheets/d/e/2PACX-1vQ2sjcmJjTCYD3p6-7pDQTmm3mCVphZIP2-5DGZOHxStucexMcdqPVsfsbnDouFcA/pub?gid=1920885371&single=true&output=csv",
  "Sindue Tombusabora": "https://docs.google.com/spreadsheets/d/e/2PACX-1vRYHOyrOQ_hNjC1L1FoIMVbbWES0dPGb1OaU6V--PV_lm0O97IHFvtPRhgRNXn_dA/pub?gid=1974330298&single=true&output=csv",
  "Sindue Tobata": "https://docs.google.com/spreadsheets/d/e/2PACX-1vQIbvzs-jZRcf1z0uV_Ahwh6dNdBgBHw66T358D9wd0-DHimDs8r4ajCvZwLa8Srg/pub?gid=801352666&single=true&output=csv",
  "Sirenja": "https://docs.google.com/spreadsheets/d/e/2PACX-1vROhU6H6reNQxHKsAmYYgfcaSZyis1vALTmBkYhjAp7BGX_wNdA2cVdgOjFQIIgjQ/pub?output=csv",
  "Balaesang": "https://docs.google.com/spreadsheets/d/e/2PACX-1vQIf6mV6qgS6fmRe3jz305N8wCDdKWJcKKWSxHtybbo7xoERx15unD-x4rgyFxF-g/pub?gid=1401841928&single=true&output=csv",
  "Balaesang Tanjung": "https://docs.google.com/spreadsheets/d/e/2PACX-1vQRojLHXJ4W6IEdiNn34kZrMgr5QvPZllm85-sbgD0WxjG6vFMUMQz3QzzGnM-7pw/pub?gid=820099832&single=true&output=csv",
  "Dampelas": "https://docs.google.com/spreadsheets/d/e/2PACX-1vR_BmCgfv-HOMRKzNMZ1aHL05CZsR7Ie0VZGRJTD29tX1C-ANiKASW1hB_PM69WuQ/pub?gid=1489077321&single=true&output=csv",
  "Sojol": "https://docs.google.com/spreadsheets/d/e/2PACX-1vT64A3AbrmT4TK8fLj5ctUc3LLMESXVTOuw3nBd2qRTEFIljaxTBW3-Z5u4w7W2Ng/pub?gid=1781390946&single=true&output=csv",
  "Sojol Utara": "https://docs.google.com/spreadsheets/d/e/2PACX-1vT41KwECicPb2EY8d8BP1f73RM3dhVWYDOxpaFlHZluKFy9owLzyVX7N7mIUm37Tw/pub?gid=502544387&single=true&output=csv"
};

/* ================== State & Util ================== */
let dataKecamatan = {}; // {kec: [rows]}
let chartPieKab=null;
let chartBarKec=null;

const norm = s => (s||"").toLowerCase().trim();
const parseNum = v => parseFloat((v??"0").toString().replace(/[^0-9,.-]/g,"").replace(/\./g,"").replace(/,/g,".")) || 0;

function groupBy(arr, key){
  return arr.reduce((m, r)=>{
    const k = r[key] || "";
    if(!m[k]) m[k]=[];
    m[k].push(r);
    return m;
  },{});
}

/* ================== Load & Map Data (Auto Detect Header) ================== */
function mapRows(parsed){
  const headers = parsed.meta.fields || [];
  const hMap = {};
  headers.forEach(h => hMap[norm(h)] = h);

  return parsed.data.map(r => ({
    sekolah: r[hMap["pengguna barang"]] || "",
    barang:  r[hMap["nama barang"]] || "",
    nibar:   r[hMap["nibar"]] || r[hMap["no. register"]] || "",
    kondisiSebelumnya: r[hMap["kondisi sebelumnya"]] || "",
    kondisiSaatIni:    r[hMap["kondisi saat ini"]]    || "",
    nilai: parseNum(r[hMap["harga perolehan"]] || r[hMap["nilai perolehan"]] || r[hMap["nilai"]])
  }));
}

function loadCSV(url){
  return new Promise((resolve,reject)=>{
    Papa.parse(url,{
      download:true, header:true, skipEmptyLines:true,
      complete: res => resolve(res),
      error: err => reject(err)
    });
  });
}

async function loadAll(){
  for(const [kec,url] of Object.entries(kecamatanEndpoints)){
    const parsed = await loadCSV(url);
    dataKecamatan[kec] = mapRows(parsed);
  }
  populateFilters();
  updateData();
}

/* ================== Filters ================== */
function populateFilters(){
  const selKec = document.getElementById("filterKecamatan");
  selKec.innerHTML = "<option value=''>Semua Kecamatan</option>";
  Object.keys(dataKecamatan).forEach(k=>{
    const o = document.createElement("option");
    o.value = k; o.textContent = k;
    selKec.appendChild(o);
  });
  updateSekolahFilter();
}

function updateSekolahFilter(){
  const kec = document.getElementById("filterKecamatan").value;
  const selSek = document.getElementById("filterSekolah");
  selSek.innerHTML = "<option value=''>Semua Sekolah</option>";
  if(kec && dataKecamatan[kec]){
    const sekolahList = [...new Set(dataKecamatan[kec].map(r=>r.sekolah).filter(Boolean))].sort();
    sekolahList.forEach(s=>{
      const o=document.createElement("option");
      o.value=s; o.textContent=s;
      selSek.appendChild(o);
    });
  }
  updateData();
}

/* ================== Main Update ================== */
function updateData(){
  const filterKec = document.getElementById("filterKecamatan").value;
  const filterSek = document.getElementById("filterSekolah").value;

  const tbody = document.querySelector("#rekapTable tbody");
  tbody.innerHTML = "";

  // Akumulasi kabupaten
  let kabSekolah = new Set();
  let kabBarang = 0;
  let kabNilai = 0;
  let totSeb = {baik:0, ringan:0, berat:0};
  let totSek = {baik:0, ringan:0, berat:0};

  // Ringkasan per kecamatan untuk bar chart
  const perKec = {};

  for(const [kec, rows] of Object.entries(dataKecamatan)){
    if(filterKec && kec !== filterKec) continue;

    let setSek = new Set();
    let jBarang = 0;
    let jNilai  = 0;
    let sblm = {baik:0, ringan:0, berat:0};
    let skrg = {baik:0, ringan:0, berat:0};

    rows.forEach(r=>{
      if(filterSek && r.sekolah !== filterSek) return;

      if(r.sekolah){ setSek.add(r.sekolah); kabSekolah.add(r.sekolah); }
      if(r.barang){ jBarang++; kabBarang++; }
      jNilai += r.nilai; kabNilai += r.nilai;

      // normalisasi isi kondisi
      const ksbl = norm(r.kondisiSebelumnya);
      const kskr = norm(r.kondisiSaatIni);
      if(ksbl.includes("baik")) sblm.baik++;
      else if(ksbl.includes("ringan")) sblm.ringan++;
      else if(ksbl.includes("berat")) sblm.berat++;

      if(kskr.includes("baik")) skrg.baik++;
      else if(kskr.includes("ringan")) skrg.ringan++;
      else if(kskr.includes("berat")) skrg.berat++;
    });

    // akumulasi kabupaten
    totSeb.baik+=sblm.baik; totSeb.ringan+=sblm.ringan; totSeb.berat+=sblm.berat;
    totSek.baik+=skrg.baik; totSek.ringan+=skrg.ringan; totSek.berat+=skrg.berat;

    perKec[kec] = { ...skrg };

    // tampilkan baris rekap hanya jika tidak memilih sekolah
    if(!filterSek){
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${kec}</td>
        <td>${setSek.size}</td>
        <td>${jBarang}</td>
        <td>${jNilai.toLocaleString("id-ID")}</td>
        <td>${sblm.baik}</td><td>${sblm.ringan}</td><td>${sblm.berat}</td>
        <td>${skrg.baik}</td><td>${skrg.ringan}</td><td>${skrg.berat}</td>
      `;
      tbody.appendChild(tr);
    }
  }

  // Summary kabupaten
  document.getElementById("summaryKabupaten").innerHTML = `
    <div class="summary-row">
      <div class="summary-item"><strong>Jumlah Sekolah:</strong> ${kabSekolah.size}</div>
      <div class="summary-item"><strong>Jumlah Barang:</strong> ${kabBarang}</div>
      <div class="summary-item"><strong>Total Nilai:</strong> Rp ${kabNilai.toLocaleString("id-ID")}</div>
    </div>
    <div class="summary-row">
      <div class="summary-item"><strong>Kondisi Sebelumnya:</strong>
        Baik: ${totSeb.baik}, Ringan: ${totSeb.ringan}, Berat: ${totSeb.berat}</div>
      <div class="summary-item"><strong>Kondisi Saat Ini:</strong>
        Baik: ${totSek.baik}, Ringan: ${totSek.ringan}, Berat: ${totSek.berat}</div>
    </div>
  `;

  // Grafik
  drawPieKab(totSek.baik, totSek.ringan, totSek.berat);
  if(!filterSek) drawBarPerKec(perKec); // kalau pilih sekolah, bar per kec disembunyikan (tidak dirender ulang)

  // Detail
  renderDetail(filterKec, filterSek);
}

/* ================== Charts ================== */
function drawPieKab(baik, ringan, berat){
  const ctx = document.getElementById("chartKondisi").getContext("2d");
  if(chartPieKab) chartPieKab.destroy();
  chartPieKab = new Chart(ctx,{
    type:"pie",
    data:{
      labels:["Baik","Rusak Ringan","Rusak Berat"],
      datasets:[{data:[baik,ringan,berat], backgroundColor:["#4CAF50","#FFC107","#F44336"]}]
    },
    options:{plugins:{legend:{position:"bottom"}}}
  });
}

function drawBarPerKec(perKec){
  const ctx = document.getElementById("chartSummary").getContext("2d");
  if(chartBarKec) chartBarKec.destroy();
  const labels = Object.keys(perKec);
  const baik   = labels.map(k=>perKec[k].baik||0);
  const ringan = labels.map(k=>perKec[k].ringan||0);
  const berat  = labels.map(k=>perKec[k].berat||0);

  chartBarKec = new Chart(ctx,{
    type:"bar",
    data:{
      labels,
      datasets:[
        {label:"Baik", data:baik,   backgroundColor:"#4CAF50"},
        {label:"Rusak Ringan", data:ringan, backgroundColor:"#FFC107"},
        {label:"Rusak Berat", data:berat,  backgroundColor:"#F44336"}
      ]
    },
    options:{
      responsive:true,
      scales:{x:{stacked:true}, y:{stacked:true, beginAtZero:true}},
      plugins:{legend:{position:"bottom"}}
    }
  });
}

/* ================== Detail Sekolah ================== */
function renderDetail(filterKec, filterSek){
  const container = document.getElementById("detailSekolah");
  container.innerHTML = "";

  for(const [kec, rows] of Object.entries(dataKecamatan)){
    if(filterKec && kec !== filterKec) continue;

    // Group per sekolah, dan hormati filter sekolah jika dipilih
    const items = rows.filter(r => !filterSek || r.sekolah === filterSek);
    const g = groupBy(items, "sekolah");

    for(const [sekolah, list] of Object.entries(g)){
      if(!sekolah) continue;
      const h3 = document.createElement("h3");
      h3.textContent = `${sekolah} (${kec})`;
      container.appendChild(h3);

      const table = document.createElement("table");
      table.className = "detail-table";
      table.innerHTML = `
        <thead>
          <tr>
            <th>Nama Barang</th>
            <th>NIBAR</th>
            <th>Kondisi Sebelumnya</th>
            <th>Kondisi Saat Ini</th>
            <th>Nilai Perolehan (Rp)</th>
          </tr>
        </thead>
        <tbody></tbody>
      `;
      const tbody = table.querySelector("tbody");
      list.forEach(it=>{
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${it.barang}</td>
          <td>${it.nibar}</td>
          <td>${it.kondisiSebelumnya}</td>
          <td>${it.kondisiSaatIni}</td>
          <td>${(it.nilai||0).toLocaleString("id-ID")}</td>
        `;
        tbody.appendChild(tr);
      });
      container.appendChild(table);
    }
  }
}

/* ================== Export Excel ================== */
function exportExcel(){
  const kec = document.getElementById("filterKecamatan").value;
  const sek = document.getElementById("filterSekolah").value;

  // Jika sekolah dipilih â†’ ekspor detail sekolah (table pertama di #detailSekolah)
  if(sek){
    const firstDetailTable = document.querySelector("#detailSekolah table");
    if(!firstDetailTable){
      alert("Tidak ada data detail untuk diekspor.");
      return;
    }
    const wb = XLSX.utils.table_to_book(firstDetailTable, {sheet:"Detail"});
    XLSX.writeFile(wb, `Detail_${sanitizeFile(kec||"SemuaKecamatan")}_${sanitizeFile(sek)}.xlsx`);
    return;
  }

  // Jika tidak pilih sekolah â†’ ekspor tabel rekap kecamatan
  const rekapTable = document.querySelector("#rekapTable");
  const wb = XLSX.utils.table_to_book(rekapTable, {sheet:"Rekap"});
  XLSX.writeFile(wb, `Rekap_${sanitizeFile(kec||"Kabupaten")}.xlsx`);
}

function sanitizeFile(name){
  return (name||"").replace(/[\\/:*?"<>|]+/g,"-").replace(/\s+/g,"_");
}

/* ================== Init ================== */
loadAll();
</script>
</body>
</html>
