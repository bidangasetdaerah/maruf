<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Dashboard Aset Sekolah</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.19.3/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    table { border-collapse: collapse; width: 100%; margin-top: 15px; }
    th, td { border: 1px solid #ddd; padding: 6px; }
    th { background: #f0f0f0; }
    .hidden { display: none; }
    .expand { cursor: pointer; color: blue; text-decoration: underline; }
    #loading { display: none; text-align: center; margin: 20px; font-weight: bold; }
    .spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #3498db;
      border-radius: 50%;
      width: 30px;
      height: 30px;
      animation: spin 1s linear infinite;
      margin: 10px auto;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <h2>ðŸ“Š Dashboard Aset Sekolah</h2>

  <select id="kecamatanSelect" onchange="showDetail(this.value)">
    <option value="">-- Pilih Kecamatan --</option>
    <option>Banawa</option>
    <option>Banawa Tengah</option>
    <option>Banawa Selatan</option>
    <option>Rio Pakava</option>
    <option>Pinembani</option>
    <option>Tanantovea</option>
    <option>Labuan</option>
    <option>Sindue</option>
    <option>Sindue Tombusabora</option>
    <option>Sindue Tobata</option>
    <option>Sirenja</option>
    <option>Balaesang</option>
    <option>Balaesang Tanjung</option>
    <option>Dampelas</option>
    <option>Sojol</option>
    <option>Sojol Utara</option>
  </select>

  <div id="buttons" class="hidden">
    <button onclick="exportExcel()">ðŸ“Š Export Excel</button>
    <button onclick="exportPDF()">ðŸ“„ Export PDF</button>
  </div>

  <!-- Loading spinner -->
  <div id="loading">
    <div class="spinner"></div>
    Sedang memuat data...
  </div>

  <div id="detail"></div>

<script>
const dataKecamatan = {
  "Banawa": "https://docs.google.com/spreadsheets/d/e/2PACX-1vRd8vIhHDUbmD6I2aXLX7-_Ysemt2aXA__wKNGoKN0XWWSWCScv5aSmx06H0xkl8g/pub?gid=1917777904&single=true&output=csv",
  "Banawa Tengah": "https://docs.google.com/spreadsheets/d/e/2PACX-1vRnykw5e_i3dwBIeTua-mpFExEJ4w6hROJ5F6OUHiiGpbtunldeKgXlhN_G-D1V8w/pub?gid=1454720232&single=true&output=csv",
  "Banawa Selatan": "https://docs.google.com/spreadsheets/d/e/2PACX-1vRhDJK33BtCz7KEi6DWgqheZBrcdgK0X9Pw1r28u5ec1MK-I-kP-QOqrsY0G2OnEQ/pub?gid=708970016&single=true&output=csv",
  "Rio Pakava": "https://docs.google.com/spreadsheets/d/1_8YllqyTXGDZZCVeozFKAhGru2WS15Bp/export?format=csv",
  "Pinembani": "https://docs.google.com/spreadsheets/d/e/2PACX-1vQshgCYmG0DHxcwLUzhtUamXTYnWb8tR7WQwnJq9k7ldFz_JhV4GHDE-k_dMO_pSA/pub?gid=1860451546&single=true&output=csv",
  "Tanantovea": "https://docs.google.com/spreadsheets/d/e/2PACX-1vR3MhjBMD3q8UIfOTdAUOHKMdeGcwr3y2YQGFcDmHDd0IVsOsAECl511LsNJ9ynow9cmY4yBpP1jENa/pub?gid=1200528899&single=true&output=csv",
  "Labuan": "https://docs.google.com/spreadsheets/d/e/2PACX-1vT7WqNsmpUBIy0-lVm2JdGg1KUKwNgQPpbSyDuuFDwB1aGPY8gsZSBWmxIgiOeJNA/pub?gid=1615242439&single=true&output=csv",
  "Sindue": "https://docs.google.com/spreadsheets/d/e/2PACX-1vQ2sjcmJjTCYD3p6-7pDQTmm3mCVphZIP2-5DGZOHxStucexMcdqPVsfsbnDouFcA/pub?gid=1920885371&single=true&output=csv",
  "Sindue Tombusabora": "https://docs.google.com/spreadsheets/d/e/2PACX-1vRYHOyrOQ_hNjC1L1FoIMVbbWES0dPGb1OaU6V--PV_lm0O97IHFvtPRhgRNXn_dA/pub?gid=1974330298&single=true&output=csv",
  "Sindue Tobata": "https://docs.google.com/spreadsheets/d/e/2PACX-1vQIbvzs-jZRcf1z0uV_Ahwh6dNdBgBHw66T358D9wd0-DHimDs8r4ajCvZwLa8Srg/pub?gid=801352666&single=true&output=csv",
  "Sirenja": "https://docs.google.com/spreadsheets/d/e/2PACX-1vROhU6H6reNQxHKsAmYYgfcaSZyis1vALTmBkYhjAp7BGX_wNdA2cVdgOjFQIIgjQ/pub?output=csv",
  "Balaesang": "https://docs.google.com/spreadsheets/d/e/2PACX-1vQIf6mV6qgS6fmRe3jz305N8wCDdKWJcKKWSxHtybbo7xoERx15unD-x4rgyFxF-g/pub?gid=1401841928&single=true&output=csv",
  "Balaesang Tanjung": "https://docs.google.com/spreadsheets/d/e/2PACX-1vQRojLHXJ4W6IEdiNn34kZrMgr5QvPZllm85-sbgD0WxjG6vFMUMQz3QzzGnM-7pw/pub?gid=820099832&single=true&output=csv",
  "Dampelas": "https://docs.google.com/spreadsheets/d/e/2PACX-1vR_BmCgfv-HOMRKzNMZ1aHL05CZsR7Ie0VZGRJTD29tX1C-ANiKASW1hB_PM69WuQ/pub?gid=1489077321&single=true&output=csv",
  "Sojol": "https://docs.google.com/spreadsheets/d/e/2PACX-1vT64A3AbrmT4TK8fLj5ctUc3LLMESXVTOuw3nBd2qRTEFIljaxTBW3-Z5u4w7W2Ng/pub?gid=1781390946&single=true&output=csv",
  "Sojol Utara": "https://docs.google.com/spreadsheets/d/e/2PACX-1vT41KwECicPb2EY8d8BP1f73RM3dhVWYDOxpaFlHZluKFy9owLzyVX7N7mIUm37Tw/pub?gid=502544387&single=true&output=csv"
};

let schoolChartInstance=null;
let schoolChartData={labels:[],baik:[],ringan:[],berat:[]};

async function showDetail(kec){
  const detailDiv=document.getElementById("detail");
  const loading=document.getElementById("loading");

  if(!kec || !dataKecamatan[kec]){
    detailDiv.innerHTML="";
    document.getElementById("buttons").classList.add("hidden");
    return;
  }

  loading.style.display="block";
  detailDiv.innerHTML="";

  try {
    const response=await fetch(dataKecamatan[kec]);
    const csvText=await response.text();
    const parsed=Papa.parse(csvText,{header:true,skipEmptyLines:true});
    const list=parsed.data.map(r=>({
      sekolah:r["Sekolah"],
      barang:r["Nama Barang"],
      nibar:r["NIBAR"],
      kondisiSebelumnya:r["Kondisi Sebelumnya"],
      kondisiSaatIni:r["Kondisi Saat Ini"],
      nilai:parseInt(r["Nilai"])||0
    }));

    renderDetail(kec,list);

  } catch(err){
    detailDiv.innerHTML=`<p style="color:red">Gagal memuat data: ${err.message}</p>`;
  } finally {
    loading.style.display="none";
  }
}

function renderDetail(kec,list){
  const detailDiv=document.getElementById("detail");
  document.getElementById("buttons").classList.remove("hidden");

  // group per sekolah
  const sekolahMap={};
  list.forEach(r=>{
    if(!sekolahMap[r.sekolah]) sekolahMap[r.sekolah]=[];
    sekolahMap[r.sekolah].push(r);
  });

  // hitung total kondisi kecamatan
  let baik=0, ringan=0, berat=0;
  for(const s in sekolahMap){
    sekolahMap[s].forEach(r=>{
      if(r.kondisiSaatIni==="Baik") baik++;
      else if(r.kondisiSaatIni==="Rusak Ringan") ringan++;
      else if(r.kondisiSaatIni==="Rusak Berat") berat++;
    });
  }

  let html=`<h3>Kecamatan ${kec}</h3>
            <canvas id="pieChart" width="300" height="300"></canvas>
            <div id="chartFilter">
              <label><input type="checkbox" value="Baik" checked onchange="updateSchoolChart()"> Baik</label>
              <label><input type="checkbox" value="Rusak Ringan" checked onchange="updateSchoolChart()"> Rusak Ringan</label>
              <label><input type="checkbox" value="Rusak Berat" checked onchange="updateSchoolChart()"> Rusak Berat</label>
            </div>
            <canvas id="schoolChart" width="600" height="300"></canvas>
            <table>
              <tr><th>Sekolah</th><th>Baik</th><th>Rusak Ringan</th><th>Rusak Berat</th><th>Detail</th></tr>`;

  const sekolahLabels=[], baikArr=[], ringanArr=[], beratArr=[];
  for(const s in sekolahMap){
    let sb=0,sr=0,sbr=0;
    sekolahMap[s].forEach(r=>{
      if(r.kondisiSaatIni==="Baik") sb++;
      else if(r.kondisiSaatIni==="Rusak Ringan") sr++;
      else if(r.kondisiSaatIni==="Rusak Berat") sbr++;
    });
    sekolahLabels.push(s); baikArr.push(sb); ringanArr.push(sr); beratArr.push(sbr);

    html+=`<tr>
      <td>${s}</td><td>${sb}</td><td>${sr}</td><td>${sbr}</td>
      <td class="expand" onclick="toggleDetail('${s.replace(/'/g,"")}')">+</td>
    </tr>
    <tr id="detail-${s.replace(/'/g,"")}" class="hidden">
      <td colspan="5">
        <table>
          <tr><th>Barang</th><th>NIBAR</th><th>Kondisi Sebelumnya</th><th>Kondisi Saat Ini</th><th>Nilai</th></tr>
          ${sekolahMap[s].map(r=>`<tr>
            <td>${r.barang}</td><td>${r.nibar}</td>
            <td>${r.kondisiSebelumnya}</td><td>${r.kondisiSaatIni}</td>
            <td>${r.nilai}</td>
          </tr>`).join("")}
        </table>
      </td>
    </tr>`;
  }
  html+="</table>";
  detailDiv.innerHTML=html;

  // pie chart
  new Chart(document.getElementById("pieChart"),{
    type:"pie",
    data:{labels:["Baik","Rusak Ringan","Rusak Berat"],
      datasets:[{data:[baik,ringan,berat],backgroundColor:["#4CAF50","#FFC107","#F44336"]}]}
  });

  // simpan data sekolah untuk chart
  schoolChartData={labels:sekolahLabels,baik:baikArr,ringan:ringanArr,berat:beratArr};
  updateSchoolChart();
}

function updateSchoolChart(){
  const checked=Array.from(document.querySelectorAll("#chartFilter input:checked")).map(cb=>cb.value);
  const datasets=[];
  if(checked.includes("Baik")) datasets.push({label:"Baik",data:schoolChartData.baik,backgroundColor:"#4CAF50"});
  if(checked.includes("Rusak Ringan")) datasets.push({label:"Rusak Ringan",data:schoolChartData.ringan,backgroundColor:"#FFC107"});
  if(checked.includes("Rusak Berat")) datasets.push({label:"Rusak Berat",data:schoolChartData.berat,backgroundColor:"#F44336"});

  const ctx=document.getElementById("schoolChart").getContext("2d");
  if(schoolChartInstance) schoolChartInstance.destroy();
  schoolChartInstance=new Chart(ctx,{
    type:"bar",
    data:{labels:schoolChartData.labels,datasets:datasets},
    options:{responsive:true,scales:{x:{stacked:true},y:{stacked:true,beginAtZero:true}}}
  });
}

function toggleDetail(id){
  const row=document.getElementById("detail-"+id);
  if(row.classList.contains("hidden")) row.classList.remove("hidden");
  else row.classList.add("hidden");
}

function exportExcel(){
  const table=document.querySelector("#detail table");
  const wb=XLSX.utils.table_to_book(table,{sheet:"Sheet1"});
  XLSX.writeFile(wb,"data.xlsx");
}

async function exportPDF(){
  const {jsPDF}=window.jspdf;
  const pdf=new jsPDF("p","pt","a4");
  const element=document.getElementById("detail");
  const canvas=await html2canvas(element);
  const imgData=canvas.toDataURL("image/png");
  const imgProps=pdf.getImageProperties(imgData);
  const pdfWidth=pdf.internal.pageSize.getWidth();
  const pdfHeight=(imgProps.height*pdfWidth)/imgProps.width;
  pdf.addImage(imgData,"PNG",0,0,pdfWidth,pdfHeight);
  pdf.save("data.pdf");
}
</script>
</body>
</html>
