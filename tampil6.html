<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard Inventaris</title>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    h1 { text-align: center; }
    #loading { text-align:center; font-size:18px; margin:20px; }
    #filterBox { margin: 20px 0; text-align:center; }
    #rekap { margin: 20px 0; padding: 10px; background: #f9f9f9; border: 1px solid #ddd; }
    #rekap h3 { margin-top: 0; }
    .collapsible {
      background-color: #eee;
      cursor: pointer;
      padding: 10px;
      width: 100%;
      border: none;
      text-align: left;
      outline: none;
      font-size: 16px;
      margin-bottom: 5px;
    }
    .active, .collapsible:hover { background-color: #ccc; }
    .content {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease;
      border-left: 2px solid #ddd;
      margin-bottom: 10px;
      padding: 0 10px;
    }
    .content.show { max-height: 1000px; }
    .item-table { width: 100%; border-collapse: collapse; margin-top: 5px; }
    .item-table th, .item-table td { border: 1px solid #ddd; padding: 6px; text-align: left; }
    .item-table th { background-color: #f4f4f4; }
  </style>
</head>
<body>
  <h1>Dashboard Inventaris Aset</h1>

  <div id="filterBox">
    <label for="filterKecamatan">Filter Kecamatan: </label>
    <select id="filterKecamatan"><option value="">Semua</option></select>
    &nbsp;&nbsp;
    <label for="searchInput">Cari: </label>
    <input type="text" id="searchInput" placeholder="Sekolah / Barang...">
  </div>

  <div id="rekap">
    <h3>Ringkasan Data</h3>
    <div id="rekapContent">Sedang memuat...</div>
  </div>

  <div id="loading">Sedang memuat data...</div>
  <div id="dataTable"></div>

  <script>
    const kecamatanEndpoints = {
       "Banawa": "https://docs.google.com/spreadsheets/d/e/2PACX-1vSCAaRZ9atAiEb-BvMChP_3Wq6wtmUUlNiTWVtwzh7r9KX5sRRZpq5WppSrSebym8z6-qI3zfWQOTNu/pub?gid=0&single=true&output=csv",
  "Banawa Tengah": "https://docs.google.com/spreadsheets/d/e/2PACX-1vToEAn2MqanfOGSKsDsV0cfGeXt6mJhf7DPEzgFeBl8GQkrbzd4iFuM3tRwyo_wV6m9PlxjQ-9Z0QhC/pub?gid=0&single=true&output=csv",
  "Banawa Selatan": "https://docs.google.com/spreadsheets/d/e/2PACX-1vQwth8ToDewTdvfvhlYuywOolNFwvc6eA4wer_OGKgNk-FoDvIQaHthsQHtMiis3cAsj4AnLzYKXG9p/pub?gid=0&single=true&output=csv",
  "Rio Pakava": "https://docs.google.com/spreadsheets/d/e/2PACX-1vQQX_Z6U7nanrMlPxL8N1m40jkFiMAHCIbZQA_iljNj3QZ8Z5FGMTAzYBbAC_D9Xy2PT3fUf0LL0n7F/pub?gid=0&single=true&output=csv",
  "Pinembani": "https://docs.google.com/spreadsheets/d/e/2PACX-1vQcReqyQvHT1K094wmITv7oL1dpVGSA7K139SmWIlNcJzVItMNLyCz0Q-u5Sg1H1QXs1R9mNyL73SBj/pub?gid=0&single=true&output=csv",
  "Tanantovea": "https://docs.google.com/spreadsheets/d/e/2PACX-1vQGT-OgwESxefxs2tnW_OoIZk2c76I6fKSqaQUoibT4B_-QVNtPPMZSDnEaawJRGaLB3tP-ChoDugoi/pub?gid=0&single=true&output=csv",
  "Labuan": "https://docs.google.com/spreadsheets/d/e/2PACX-1vQaDzmjVhNzRnMTJWg2JkvR1DYTiDSl2S6-MisvcSFD9P7MB2rVxA2zRgS0Rd0-f-xpIt1db1O1ppXx/pub?gid=0&single=true&output=csv",
  "Sindue": "https://docs.google.com/spreadsheets/d/e/2PACX-1vRnq_cellwa56qRzTfYLpUxHoLxpiQOBBmiAUCkdeJK8-tLMVawW9BLrWUA_Q_kMswogfdZlmWjHGQT/pub?gid=0&single=true&output=csv",
  "Sindue Tombusabora": "https://docs.google.com/spreadsheets/d/e/2PACX-1vS11oEXPUetCOBorbbFNejuPEMsw4L8GYp-ETIbncBOgBfOtvLruTC82mUd-vxb7fj6sXopy16axzXi/pub?gid=0&single=true&output=csv",
  "Sindue Tobata": "https://docs.google.com/spreadsheets/d/e/2PACX-1vQg_48k1uaVtdc2v4UgVwn3PBxAFP4gfEhIR_OCBKVOcSrHRUYS1jPO1P1E1qnHGM_WcqDB2TFkE74t/pub?gid=0&single=true&output=csv",
  "Sirenja": "https://docs.google.com/spreadsheets/d/e/2PACX-1vQpFtH1q7lOez0grPXzNd1AAU93FZQZPSCyVrT4RneIumbxU0CbvukEfotyjhq01gYVLhK0_WblO_HO/pub?gid=0&single=true&output=csv",
  "Balaesang": "https://docs.google.com/spreadsheets/d/e/2PACX-1vQQevpAs3bjvgOzZDc8uq2PoebzqXVEFCvggoqJvn8AO-d1M0BCI0k7QYKB9hTgymfUIXx68oVR27IV/pub?gid=0&single=true&output=csv",
  "Balaesang Tanjung": "https://docs.google.com/spreadsheets/d/e/2PACX-1vQljJh_fOmCwjRVlTt5k8WxpN3TzaSyhWDXNnkDjI8hm62x1jdE41mXNENd2iGUueNyuXJuLa4jpoF6/pub?gid=0&single=true&output=csv",
  "Dampelas": "https://docs.google.com/spreadsheets/d/e/2PACX-1vTTIi8ZSNx9-MetxVLFAxiS4MeBiFOuOeYbe4_Bf9EEQ2btWYDfIY15B6r_tBg33l0AFATRQrdoQyMq/pub?gid=0&single=true&output=csv",
  "Sojol": "https://docs.google.com/spreadsheets/d/e/2PACX-1vR_M8W7eNSRgJiDs-lU0zBDAT2OEAN6J1g1G9UvgreUf7GS0_Q987XsgzYdDESWAu_P86BezxKn6nJl/pub?gid=0&single=true&output=csv",
  "Sojol Utara": "https://docs.google.com/spreadsheets/d/e/2PACX-1vRJAkrtkVPBLcUmM8OsByQDfndFGv-6MetoMsB_DGoqimZQGcAg9Lxe_glv_qAJoVXoY9TCHdnCDa6Y/pub?gid=0&single=true&output=csv"
    };

    let allDataGlobal = [];
    let currentFilter = "";
    let currentSearch = "";

    async function fetchData(url) {
      return new Promise((resolve, reject) => {
        Papa.parse(url, {
          download: true,
          header: true,
          complete: results => resolve(results.data),
          error: err => reject(err)
        });
      });
    }

    function parseNumberIndo(str) {
      if (!str) return 0;
      return parseFloat(str.trim().replace(/\./g, '').replace(',', '.')) || 0;
    }

    function mapRow(r) {
      return {
        sekolah: r["Nama Sekolah"] || r["Sekolah"] || r["Pengguna Barang"] || "",
        barang: r["Nama Barang"] || r["Barang"] || "",
        nibar: r["NIBAR"] || r["No. Register"] || "",
        konfirmasi: (r["Konfirmasi Keberadaan Kondisi Saat ini"] || r["Konfirmasi Keberadaan"] || r["Konfirmasi"] || "Tidak Ditemukan").toLowerCase().trim(),
        nilai: parseNumberIndo(r["Nilai Perolehan"] || r["Harga Perolehan"] || r["Nilai"] || "")
      };
    }

    async function loadAllData() {
      document.getElementById("loading").style.display = "block";
      let allData = [];
      for (const [kec, url] of Object.entries(kecamatanEndpoints)) {
        try {
          const raw = await fetchData(url);
          const mapped = raw.map(r => ({ kecamatan: kec, ...mapRow(r) }));
          allData = allData.concat(mapped);
        } catch (e) { console.error("Gagal load", kec, e); }
      }
      allDataGlobal = allData;
      updateFilterOptions(allData);
      renderData();
      document.getElementById("loading").style.display = "none";
    }

    function updateFilterOptions(data) {
      const kecamatanSet = new Set(data.map(d => d.kecamatan));
      const select = document.getElementById("filterKecamatan");
      kecamatanSet.forEach(kec => {
        if (![...select.options].some(opt => opt.value === kec)) {
          const option = document.createElement("option");
          option.value = kec;
          option.textContent = kec;
          select.appendChild(option);
        }
      });
    }

    function applyFilters(data) {
      return data.filter(d => {
        if (!d.sekolah && !d.barang) return false;
        if (currentFilter && d.kecamatan !== currentFilter) return false;
        if (currentSearch) {
          const keyword = currentSearch.toLowerCase().trim();
          return d.sekolah.toLowerCase().includes(keyword) || d.barang.toLowerCase().includes(keyword);
        }
        return true;
      });
    }

    function updateRekap(data) {
      const totalBarang = data.length;
      const totalNilai = data.reduce((sum, d) => sum + d.nilai, 0);
      let html = `<p><b>Total Barang:</b> ${totalBarang.toLocaleString()} | <b>Total Nilai:</b> Rp ${totalNilai.toLocaleString("id-ID")}</p>`;
      const byKec = {};
      data.forEach(d => {
        if (!byKec[d.kecamatan]) byKec[d.kecamatan] = { count:0, nilai:0 };
        byKec[d.kecamatan].count++;
        byKec[d.kecamatan].nilai += d.nilai;
      });
      html += "<ul>";
      for (const [kec,val] of Object.entries(byKec)) {
        html += `<li><b>${kec}</b>: ${val.count.toLocaleString()} barang | Rp ${val.nilai.toLocaleString("id-ID")}</li>`;
      }
      html += "</ul>";
      document.getElementById("rekapContent").innerHTML = html;
    }

    function updateTable(data) {
      const container = document.getElementById("dataTable");
      container.innerHTML = "";
      const grouped = {};
      data.forEach(d => {
        if (!grouped[d.sekolah]) grouped[d.sekolah] = [];
        grouped[d.sekolah].push(d);
      });
      for (const [sekolah, items] of Object.entries(grouped)) {
        const totalNilaiSekolah = items.reduce((s,d)=>s+d.nilai,0);
        const btn = document.createElement("button");
        btn.className = "collapsible";
        btn.textContent = `${sekolah} (${items.length} barang | Rp ${totalNilaiSekolah.toLocaleString("id-ID")})`;
        const content = document.createElement("div");
        content.className = "content";
        const table = document.createElement("table");
        table.className = "item-table";
        table.innerHTML = `
          <thead>
            <tr>
              <th>Kecamatan</th>
              <th>Barang</th>
              <th>No. Register</th>
              <th>Konfirmasi</th>
              <th>Nilai</th>
            </tr>
          </thead>
          <tbody>
            ${items.map(d => `<tr>
              <td>${d.kecamatan}</td>
              <td>${d.barang}</td>
              <td>${d.nibar}</td>
              <td>${d.konfirmasi}</td>
              <td>${d.nilai.toLocaleString("id-ID")}</td>
            </tr>`).join('')}
          </tbody>`;
        content.appendChild(table);
        container.appendChild(btn);
        container.appendChild(content);

        btn.addEventListener("click", function() {
          this.classList.toggle("active");
          content.classList.toggle("show");
        });
      }
    }

    function renderData() {
      const filtered = applyFilters(allDataGlobal);
      updateTable(filtered);
      updateRekap(filtered);
    }

    document.getElementById("filterKecamatan").addEventListener("change", e => {
      currentFilter = e.target.value;
      renderData();
    });

    document.getElementById("searchInput").addEventListener("input", e => {
      currentSearch = e.target.value;
      renderData();
    });

    loadAllData();
  </script>
</body>
</html>
