<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dashboard Inventaris Aset</title>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.tailwindcss.com"></script>
<style>
.collapsible { @apply bg-gray-200 cursor-pointer px-4 py-2 w-full text-left rounded mb-2; }
.collapsible:hover { @apply bg-gray-300; }
.content { max-height: 0; overflow: hidden; transition: max-height 0.35s ease, padding 0.35s ease; border-l-2 border-gray-300 mb-2; padding: 0 10px; }
.content.show { padding-top: 10px; padding-bottom: 10px; }
.item-table th, .item-table td { @apply border border-gray-300 px-2 py-1 text-left text-sm; }
.item-table th { @apply bg-gray-100; }
</style>
</head>
<body class="bg-gray-50 font-sans">

<header class="bg-blue-900 text-white p-4 flex justify-between items-center fixed w-full z-50 shadow">
  <div class="flex items-center gap-2">
    <img src="https://upload.wikimedia.org/wikipedia/commons/e/e5/Lambang_Kabupaten_Donggala_%282015-sekarang%29.png" class="h-8" alt="Logo">
    <h1 class="text-lg font-semibold">Dashboard Inventaris Aset</h1>
  </div>
  <button id="darkToggle" class="text-xl">🌙</button>
</header>

<main class="pt-20 px-4">
  <div class="flex flex-wrap gap-4 mb-4">
    <select id="filterKecamatan" class="border rounded px-2 py-1">
      <option value="">Semua Kecamatan</option>
    </select>
    <input type="text" id="searchInput" placeholder="Cari Sekolah / Barang..." class="border rounded px-2 py-1 flex-1">
  </div>

  <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
    <div class="bg-white p-4 rounded shadow">
      <h2 class="font-semibold mb-2">Rekap Konfirmasi</h2>
      <canvas id="chartKonfirmasi"></canvas>
    </div>
    <div class="bg-white p-4 rounded shadow">
      <h2 class="font-semibold mb-2">Rekap Kondisi Barang</h2>
      <canvas id="chartKondisi"></canvas>
    </div>
    <div class="bg-white p-4 rounded shadow">
      <h2 class="font-semibold mb-2">Rekap Nilai Perolehan</h2>
      <canvas id="chartNilai"></canvas>
    </div>
  </div>

  <div class="bg-white p-4 rounded shadow mb-6">
    <h2 class="font-semibold mb-2">Ringkasan Data</h2>
    <div id="rekapContent">Sedang memuat...</div>
  </div>

  <div id="dataTable"></div>
</main>

<script>
// Dark mode
document.getElementById("darkToggle").addEventListener("click", () => {
  document.body.classList.toggle("dark");
  document.getElementById("darkToggle").textContent = document.body.classList.contains("dark") ? "☀️" : "🌙";
});

// === Data ===
const kecamatanEndpoints = {
  "Banawa": "https://docs.google.com/spreadsheets/d/e/2PACX-1vSCAaRZ9atAiEb-BvMChP_3Wq6wtmUUlNiTWVtwzh7r9KX5sRRZpq5WppSrSebym8z6-qI3zfWQOTNu/pub?gid=0&single=true&output=csv",
  "Banawa Tengah": "https://docs.google.com/spreadsheets/d/e/2PACX-1vToEAn2MqanfOGSKsDsV0cfGeXt6mJhf7DPEzgFeBl8GQkrbzd4iFuM3tRwyo_wV6m9PlxjQ-9Z0QhC/pub?gid=0&single=true&output=csv",
  "Banawa Selatan": "https://docs.google.com/spreadsheets/d/e/2PACX-1vQwth8ToDewTdvfvhlYuywOolNFwvc6eA4wer_OGKgNk-FoDvIQaHthsQHtMiis3cAsj4AnLzYKXG9p/pub?gid=0&single=true&output=csv",
  "Rio Pakava": "https://docs.google.com/spreadsheets/d/e/2PACX-1vQQX_Z6U7nanrMlPxL8N1m40jkFiMAHCIbZQA_iljNj3QZ8Z5FGMTAzYBbAC_D9Xy2PT3fUf0LL0n7F/pub?gid=0&single=true&output=csv",
  "Pinembani": "https://docs.google.com/spreadsheets/d/e/2PACX-1vQcReqyQvHT1K094wmITv7oL1dpVGSA7K139SmWIlNcJzVItMNLyCz0Q-u5Sg1H1QXs1R9mNyL73SBj/pub?gid=0&single=true&output=csv",
  "Tanantovea": "https://docs.google.com/spreadsheets/d/e/2PACX-1vQGT-OgwESxefxs2tnW_OoIZk2c76I6fKSqaQUoibT4B_-QVNtPPMZSDnEaawJRGaLB3tP-ChoDugoi/pub?gid=0&single=true&output=csv",
  "Labuan": "https://docs.google.com/spreadsheets/d/e/2PACX-1vQaDzmjVhNzRnMTJWg2JkvR1DYTiDSl2S6-MisvcSFD9P7MB2rVxA2zRgS0Rd0-f-xpIt1db1O1ppXx/pub?gid=0&single=true&output=csv",
  "Sindue": "https://docs.google.com/spreadsheets/d/e/2PACX-1vRnq_cellwa56qRzTfYLpUxHoLxpiQOBBmiAUCkdeJK8-tLMVawW9BLrWUA_Q_kMswogfdZlmWjHGQT/pub?gid=0&single=true&output=csv",
  "Sindue Tombusabora": "https://docs.google.com/spreadsheets/d/e/2PACX-1vS11oEXPUetCOBorbbFNejuPEMsw4L8GYp-ETIbncBOgBfOtvLruTC82mUd-vxb7fj6sXopy16axzXi/pub?gid=0&single=true&output=csv",
  "Sindue Tobata": "https://docs.google.com/spreadsheets/d/e/2PACX-1vQg_48k1uaVtdc2v4UgVwn3PBxAFP4gfEhIR_OCBKVOcSrHRUYS1jPO1P1E1qnHGM_WcqDB2TFkE74t/pub?gid=0&single=true&output=csv",
  "Sirenja": "https://docs.google.com/spreadsheets/d/e/2PACX-1vQpFtH1q7lOez0grPXzNd1AAU93FZQZPSCyVrT4RneIumbxU0CbvukEfotyjhq01gYVLhK0_WblO_HO/pub?gid=0&single=true&output=csv",
  "Balaesang": "https://docs.google.com/spreadsheets/d/e/2PACX-1vQQevpAs3bjvgOzZDc8uq2PoebzqXVEFCvggoqJvn8AO-d1M0BCI0k7QYKB9hTgymfUIXx68oVR27IV/pub?gid=0&single=true&output=csv",
  "Balaesang Tanjung": "https://docs.google.com/spreadsheets/d/e/2PACX-1vQljJh_fOmCwjRVlTt5k8WxpN3TzaSyhWDXNnkDjI8hm62x1jdE41mXNENd2iGUueNyuXJuLa4jpoF6/pub?gid=0&single=true&output=csv",
  "Dampelas": "https://docs.google.com/spreadsheets/d/e/2PACX-1vTTIi8ZSNx9-MetxVLFAxiS4MeBiFOuOeYbe4_Bf9EEQ2btWYDfIY15B6r_tBg33l0AFATRQrdoQyMq/pub?gid=0&single=true&output=csv",
  "Sojol": "https://docs.google.com/spreadsheets/d/e/2PACX-1vR_M8W7eNSRgJiDs-lU0zBDAT2OEAN6J1g1G9UvgreUf7GS0_Q987XsgzYdDESWAu_P86BezxKn6nJl/pub?gid=0&single=true&output=csv",
  "Sojol Utara": "https://docs.google.com/spreadsheets/d/e/2PACX-1vRJAkrtkVPBLcUmM8OsByQDfndFGv-6MetoMsB_DGoqimZQGcAg9Lxe_glv_qAJoVXoY9TCHdnCDa6Y/pub?gid=0&single=true&output=csv"
};

let allDataGlobal = [];
let currentFilter = "";
let currentSearch = "";
let chartKonfirmasi, chartKondisi, chartNilai;

// Ambil data CSV
async function fetchData(url){
  return new Promise(resolve => {
    Papa.parse(url, { download:true, header:true, complete: res => resolve(res.data) });
  });
}

function mapRow(r, kec){
  return {
    kecamatan: kec,
    sekolah: r["Nama Sekolah"]||r["Sekolah"]||r["Pengguna Barang"]||"",
    barang: r["Nama Barang"]||r["Barang"]||"",
    nibar: r["NIBAR"]||r["No. Register"]||"",
    konfirmasi: (r["Konfirmasi Keberadaan Kondisi Saat ini"]||r["Konfirmasi Keberadaan"]||r["Konfirmasi"]||"Tidak Ditemukan").toLowerCase().trim(),
    kondisi: (r["Kondisi"]||"baik").toLowerCase().trim(),
    nilai: r["Nilai Perolehan"]||r["Harga Perolehan"]||r["Nilai"]||"0"
  };
}

async function loadAllData(){
  let allData=[];
  for(const [kec,url] of Object.entries(kecamatanEndpoints)){
    try{
      const raw = await fetchData(url);
      const mapped = raw.map(r=>mapRow(r,kec));
      allData = allData.concat(mapped);
    }catch(e){console.error("Gagal load",kec,e);}
  }
  allDataGlobal = allData;
  updateFilterOptions(allData);
  renderData();
}

function updateFilterOptions(data){
  const select = document.getElementById("filterKecamatan");
  const kecSet = new Set(data.map(d=>d.kecamatan));
  kecSet.forEach(kec=>{
    if(![...select.options].some(opt=>opt.value===kec)){
      const opt = document.createElement("option");
      opt.value=kec; opt.textContent=kec;
      select.appendChild(opt);
    }
  });
}

function applyFilters(data){
  return data.filter(d=>{
    if(currentFilter && d.kecamatan!==currentFilter) return false;
    if(currentSearch){
      const kw = currentSearch.toLowerCase();
      return d.sekolah.toLowerCase().includes(kw) || d.barang.toLowerCase().includes(kw);
    }
    return true;
  });
}

function updateRekap(data){
  const totalBarang = data.length;
  let totalNilai = data.reduce((sum,d)=>sum+parseFloat(d.nilai.replace(/\./g,'').replace(',','.')),0);
  let html = `<p>Total Barang: <b>${totalBarang}</b> | Total Nilai: <b>Rp ${totalNilai.toLocaleString('id-ID')}</b></p>`;
  
  const byKec = {};
  data.forEach(d=>{
    if(!byKec[d.kecamatan]) byKec[d.kecamatan]={count:0,nilai:0};
    byKec[d.kecamatan].count++;
    byKec[d.kecamatan].nilai+=parseFloat(d.nilai.replace(/\./g,'').replace(',','.'))||0;
  });
  html+="<ul>";
  for(const [k,val] of Object.entries(byKec)){
    html+=`<li>${k}: ${val.count} barang | Rp ${val.nilai.toLocaleString('id-ID')}</li>`;
  }
  html+="</ul>";
  document.getElementById("rekapContent").innerHTML=html;

  // Update chart
  const labelsKec = Object.keys(byKec);
  const nilaiData = labelsKec.map(k=>byKec[k].nilai);
  const jumlahData = labelsKec.map(k=>byKec[k].count);

  if(chartNilai) chartNilai.destroy();
  chartNilai = new Chart(document.getElementById("chartNilai"), {
    type:'bar',
    data:{labels:labelsKec,datasets:[{label:'Total Nilai',data:nilaiData,backgroundColor:'#6366f1'}]}
  });
  if(chartKonfirmasi) chartKonfirmasi.destroy();
  chartKonfirmasi = new Chart(document.getElementById("chartKonfirmasi"),{
    type:'pie',
    data:{labels:['Ditemukan','Tidak Ditemukan'],datasets:[{data:[
      data.filter(d=>d.konfirmasi==='ditemukan').length,
      data.filter(d=>d.konfirmasi!=='ditemukan').length
    ],backgroundColor:['#10b981','#ef4444']}]}
  });
  if(chartKondisi) chartKondisi.destroy();
  chartKondisi = new Chart(document.getElementById("chartKondisi"),{
    type:'bar',
    data:{labels:['Baik','Rusak Ringan','Rusak Berat'],datasets:[{data:[
      data.filter(d=>d.kondisi==='baik').length,
      data.filter(d=>d.kondisi==='rusak ringan').length,
      data.filter(d=>d.kondisi==='rusak berat').length
    ],backgroundColor:['#3b82f6','#facc15','#f87171']}]}
  });
}

function updateTable(data){
  const container = document.getElementById("dataTable");
  container.innerHTML="";
  const grouped = {};
  data.forEach(d=>{
    if(!grouped[d.sekolah]) grouped[d.sekolah]=[];
    grouped[d.sekolah].push(d);
  });
  for(const [sekolah,items] of Object.entries(grouped)){
    const totalNilai = items.reduce((s,d)=>s+parseFloat(d.nilai.replace(/\./g,'').replace(',','.')),0);
    const btn = document.createElement("button");
    btn.className="collapsible";
    btn.textContent=`${sekolah} (${items.length} barang | Rp ${totalNilai.toLocaleString('id-ID')})`;
    const content = document.createElement("div");
    content.className="content overflow-hidden";
    const table = document.createElement("table");
    table.className="item-table w-full";
    table.innerHTML=`
      <thead>
        <tr>
          <th>Kecamatan</th>
          <th>Barang</th>
          <th>No. Register</th>
          <th>Konfirmasi</th>
          <th>Kondisi</th>
          <th>Nilai</th>
        </tr>
      </thead>
      <tbody>
        ${items.map(d=>`<tr>
          <td>${d.kecamatan}</td>
          <td>${d.barang}</td>
          <td>${d.nibar}</td>
          <td>${d.konfirmasi}</td>
          <td>${d.kondisi}</td>
          <td>${d.nilai}</td>
        </tr>`).join('')}
      </tbody>`;
    content.appendChild(table);
    container.appendChild(btn);
    container.appendChild(content);

    btn.addEventListener("click",()=>{
      if(content.style.maxHeight && content.style.maxHeight!=="0px"){
        content.style.maxHeight="0px";
        content.style.paddingTop="0px"; content.style.paddingBottom="0px";
      }else{
        content.style.maxHeight = content.scrollHeight + 20 + "px";
        content.style.paddingTop="10px"; content.style.paddingBottom="10px";
      }
    });
  }
}

function renderData(){
  const filtered = applyFilters(allDataGlobal);
  updateTable(filtered);
  updateRekap(filtered);
}

document.getElementById("filterKecamatan").addEventListener("change", e=>{
  currentFilter=e.target.value;
  renderData();
});
document.getElementById("searchInput").addEventListener("input", e=>{
  currentSearch=e.target.value;
  renderData();
});

loadAllData();
</script>
</body>
</html>
