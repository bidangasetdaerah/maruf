<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard KIB B - DINAS PENDIDIKAN DAN KEBUDAYAAN</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <style>
    body { font-family: sans-serif; margin: 0; background-color: #f9fafb; }
    h1 { font-size: 1.5rem; margin-bottom: 10px; text-align: center; }
    h2 { font-size: 1.2rem; margin-top: 20px; }
    h3 { font-size: 1rem; margin-top: 15px; color: #1f2937; }
    .navbar {
      background-color: #3b82f6;
      color: white;
      padding: 10px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: sticky;
      top: 0;
      z-index: 1000;
    }
    .navbar h1 { margin: 0; font-size: 1.2rem; }
    .navbar ul {
      list-style: none;
      display: flex;
      gap: 15px;
      margin: 0;
      padding: 0;
    }
    .navbar ul li a {
      color: white;
      text-decoration: none;
      font-size: 0.9rem;
      font-weight: bold;
    }
    .navbar ul li a:hover {
      text-decoration: underline;
    }
    .container { padding: 15px; }
    .dashboard { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 15px; }
    .chart-container, table { background: white; border-radius: 8px; padding: 10px; box-shadow: 0 2px 6px rgba(0,0,0,0.1); }
    .chart-container { flex: 1 1 300px; }
    canvas { width: 100% !important; height: 250px !important; }
    table { width: 100%; border-collapse: collapse; font-size: 0.85rem; margin-top: 10px; }
    th, td { border: 1px solid #ddd; padding: 6px; text-align: left; }
    th { background-color: #3b82f6; color: white; font-size: 0.8rem; }
    .last-update { font-size: 0.8rem; color: #555; margin-top: 5px; }
    .controls { margin: 15px 0; display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
    input, select { padding: 5px; border: 1px solid #ccc; border-radius: 5px; }
  </style>
</head>
<body>

  <div class="navbar">
  <div style="display:flex; align-items:center; gap:10px;">
    <img src="https://upload.wikimedia.org/wikipedia/commons/e/e5/Lambang_Kabupaten_Donggala_%282015-sekarang%29.png" alt="Logo" style="height:32px;">
    <h1>DINAS PENDIDIKAN DAN KEBUDAYAAN</h1>
  </div>
  <ul>
    <li><a href="#rekapTable">Rekap Kecamatan</a></li>
    <li><a href="#sekolahSection">Daftar Sekolah</a></li>
    <li><a href="#">Tentang</a></li>
  </ul>
</div>

  <div class="container">
    <h1>Dashboard Data Aset KIB B - Dinas Pendidikan Dan Kebudayaan</h1>

    <div class="controls">
      <label><b>Filter Kecamatan:</b></label>
      <select id="filterKecamatan">
        <option value="all">Semua Kecamatan</option>
      </select>

      <label><b>Cari Sekolah:</b></label>
      <input type="text" id="searchBox" placeholder="Ketik nama sekolah...">
    </div>

    <div class="dashboard">
      <div class="chart-container">
        <h2>Rekap Konfirmasi Keberadaan</h2>
        <canvas id="rekapKonfirmasi"></canvas>
      </div>
      <div class="chart-container">
        <h2>Rekap Kondisi Barang</h2>
        <canvas id="rekapKondisi"></canvas>
      </div>
      <div class="chart-container">
        <h2>Rekap Nilai Perolehan per Kondisi</h2>
        <canvas id="rekapNilai"></canvas>
      </div>
    </div>

    <h2>Rekap Per Kecamatan</h2>
    <div id="lastUpdate" class="last-update">Memuat data...</div>
    <table id="rekapTable">
      <thead>
        <tr>
          <th>Kecamatan</th>
          <th>Ditemukan</th>
          <th>Tidak Ditemukan</th>
          <th>Baik</th>
          <th>Rusak Ringan</th>
          <th>Rusak Berat</th>
          <th>Nilai Perolehan (Rp)</th>
        </tr>
      </thead>
      <tbody></tbody>
      <tfoot>
        <tr style="font-weight:bold; background:#e5e7eb;">
          <td>Total</td>
          <td id="totalDitemukan">0</td>
          <td id="totalTidakDitemukan">0</td>
          <td id="totalBaik">0</td>
          <td id="totalRusakRingan">0</td>
          <td id="totalRusakBerat">0</td>
          <td id="totalNilai">0</td>
        </tr>
      </tfoot>
    </table>

    <div id="sekolahSection"></div>
  </div>

  <script>
  const kecamatanEndpoints = {
     "Banawa": "https://docs.google.com/spreadsheets/d/e/2PACX-1vSCAaRZ9atAiEb-BvMChP_3Wq6wtmUUlNiTWVtwzh7r9KX5sRRZpq5WppSrSebym8z6-qI3zfWQOTNu/pub?gid=0&single=true&output=csv",
  "Banawa Tengah": "https://docs.google.com/spreadsheets/d/e/2PACX-1vToEAn2MqanfOGSKsDsV0cfGeXt6mJhf7DPEzgFeBl8GQkrbzd4iFuM3tRwyo_wV6m9PlxjQ-9Z0QhC/pub?gid=0&single=true&output=csv",
  "Banawa Selatan": "https://docs.google.com/spreadsheets/d/e/2PACX-1vQwth8ToDewTdvfvhlYuywOolNFwvc6eA4wer_OGKgNk-FoDvIQaHthsQHtMiis3cAsj4AnLzYKXG9p/pub?gid=0&single=true&output=csv",
  "Rio Pakava": "https://docs.google.com/spreadsheets/d/e/2PACX-1vQQX_Z6U7nanrMlPxL8N1m40jkFiMAHCIbZQA_iljNj3QZ8Z5FGMTAzYBbAC_D9Xy2PT3fUf0LL0n7F/pub?gid=0&single=true&output=csv",
  "Pinembani": "https://docs.google.com/spreadsheets/d/e/2PACX-1vQcReqyQvHT1K094wmITv7oL1dpVGSA7K139SmWIlNcJzVItMNLyCz0Q-u5Sg1H1QXs1R9mNyL73SBj/pub?gid=0&single=true&output=csv",
  "Tanantovea": "https://docs.google.com/spreadsheets/d/e/2PACX-1vQGT-OgwESxefxs2tnW_OoIZk2c76I6fKSqaQUoibT4B_-QVNtPPMZSDnEaawJRGaLB3tP-ChoDugoi/pub?gid=0&single=true&output=csv",
  "Labuan": "https://docs.google.com/spreadsheets/d/e/2PACX-1vQaDzmjVhNzRnMTJWg2JkvR1DYTiDSl2S6-MisvcSFD9P7MB2rVxA2zRgS0Rd0-f-xpIt1db1O1ppXx/pub?gid=0&single=true&output=csv",
  "Sindue": "https://docs.google.com/spreadsheets/d/e/2PACX-1vRnq_cellwa56qRzTfYLpUxHoLxpiQOBBmiAUCkdeJK8-tLMVawW9BLrWUA_Q_kMswogfdZlmWjHGQT/pub?gid=0&single=true&output=csv",
  "Sindue Tombusabora": "https://docs.google.com/spreadsheets/d/e/2PACX-1vS11oEXPUetCOBorbbFNejuPEMsw4L8GYp-ETIbncBOgBfOtvLruTC82mUd-vxb7fj6sXopy16axzXi/pub?gid=0&single=true&output=csv",
  "Sindue Tobata": "https://docs.google.com/spreadsheets/d/e/2PACX-1vQg_48k1uaVtdc2v4UgVwn3PBxAFP4gfEhIR_OCBKVOcSrHRUYS1jPO1P1E1qnHGM_WcqDB2TFkE74t/pub?gid=0&single=true&output=csv",
  "Sirenja": "https://docs.google.com/spreadsheets/d/e/2PACX-1vQpFtH1q7lOez0grPXzNd1AAU93FZQZPSCyVrT4RneIumbxU0CbvukEfotyjhq01gYVLhK0_WblO_HO/pub?gid=0&single=true&output=csv",
  "Balaesang": "https://docs.google.com/spreadsheets/d/e/2PACX-1vQQevpAs3bjvgOzZDc8uq2PoebzqXVEFCvggoqJvn8AO-d1M0BCI0k7QYKB9hTgymfUIXx68oVR27IV/pub?gid=0&single=true&output=csv",
  "Balaesang Tanjung": "https://docs.google.com/spreadsheets/d/e/2PACX-1vQljJh_fOmCwjRVlTt5k8WxpN3TzaSyhWDXNnkDjI8hm62x1jdE41mXNENd2iGUueNyuXJuLa4jpoF6/pub?gid=0&single=true&output=csv",
  "Dampelas": "https://docs.google.com/spreadsheets/d/e/2PACX-1vTTIi8ZSNx9-MetxVLFAxiS4MeBiFOuOeYbe4_Bf9EEQ2btWYDfIY15B6r_tBg33l0AFATRQrdoQyMq/pub?gid=0&single=true&output=csv",
  "Sojol": "https://docs.google.com/spreadsheets/d/e/2PACX-1vR_M8W7eNSRgJiDs-lU0zBDAT2OEAN6J1g1G9UvgreUf7GS0_Q987XsgzYdDESWAu_P86BezxKn6nJl/pub?gid=0&single=true&output=csv",
  "Sojol Utara": "https://docs.google.com/spreadsheets/d/e/2PACX-1vRJAkrtkVPBLcUmM8OsByQDfndFGv-6MetoMsB_DGoqimZQGcAg9Lxe_glv_qAJoVXoY9TCHdnCDa6Y/pub?gid=0&single=true&output=csv"
  };

  let chartKonfirmasi, chartKondisi, chartNilai;

  async function fetchData(url) {
    return new Promise((resolve) => {
      if (!url) return resolve([]);
      Papa.parse(url, { download: true, header: true, complete: (res) => resolve(res.data) });
    });
  }

  function parseNumber(value) {
    if (!value) return 0;
    if (typeof value === "number") return value;
    return parseFloat(value.toString().replace(/[^\d,-]/g, "").replace(",", ".") || 0);
  }

  async function updateData() {
    const filter = document.getElementById("filterKecamatan").value;
    const search = document.getElementById("searchBox").value.toLowerCase();

    const tbody = document.querySelector("#rekapTable tbody");
    tbody.innerHTML = "";
    document.getElementById("sekolahSection").innerHTML = "";

    let total = { Ditemukan:0, Tidak:0, Baik:0, Ringan:0, Berat:0, Nilai:0 };

    for (const [nama, url] of Object.entries(kecamatanEndpoints)) {
      if (filter !== "all" && filter !== nama) continue;

      const data = await fetchData(url);
      let ditemukan=0, tidak=0, baik=0, ringan=0, berat=0, nilai=0;
      const sekolahMap = {};

      data.forEach(row=>{
        const k = row["Konfirmasi Keberadaan"] || "Tidak Ditemukan";
        const c = row["Kondisi"] || "Baik";
        const v = parseNumber(row["Harga Perolehan"] || row["Nilai Perolehan"]);
        const sekolah = row["Pengguna Barang"] || row["Nama Sekolah"] || "";

        if(k==="Ditemukan") ditemukan++; else tidak++;
        if(c==="Baik") baik++;
        else if(c==="Rusak Ringan") ringan++;
        else if(c==="Rusak Berat") berat++;
        nilai += v;

        if(sekolah){
          if(!sekolahMap[sekolah]) sekolahMap[sekolah] = { barang:0, nilai:0 };
          sekolahMap[sekolah].barang++;
          sekolahMap[sekolah].nilai += v;
        }
      });

      total.Ditemukan+=ditemukan;
      total.Tidak+=tidak;
      total.Baik+=baik;
      total.Ringan+=ringan;
      total.Berat+=berat;
      total.Nilai+=nilai;

      const tr = document.createElement("tr");
      tr.innerHTML = `<td>${nama}</td>
                      <td>${ditemukan}</td>
                      <td>${tidak}</td>
                      <td>${baik}</td>
                      <td>${ringan}</td>
                      <td>${berat}</td>
                      <td>${nilai.toLocaleString("id-ID")}</td>`;
      tbody.appendChild(tr);

      const section = document.getElementById("sekolahSection");
      let html = `<h3>Daftar Sekolah - ${nama}</h3>
                  <table>
                    <thead>
                      <tr><th>Nama Sekolah</th><th>Jumlah Barang</th><th>Nilai Perolehan (Rp)</th></tr>
                    </thead>
                    <tbody>`;
      let totalBarang=0, totalNilai=0;
      for(const [sekolah, val] of Object.entries(sekolahMap)){
        if(search && !sekolah.toLowerCase().includes(search)) continue;
        html += `<tr><td>${sekolah}</td><td>${val.barang}</td><td>${val.nilai.toLocaleString("id-ID")}</td></tr>`;
        totalBarang += val.barang;
        totalNilai += val.nilai;
      }
      html += `</tbody>
               <tfoot><tr style="font-weight:bold; background:#e5e7eb;">
                 <td>Total</td><td>${totalBarang}</td><td>${totalNilai.toLocaleString("id-ID")}</td>
               </tr></tfoot></table>`;
      section.innerHTML += html;
    }

    document.getElementById("totalDitemukan").textContent = total.Ditemukan;
    document.getElementById("totalTidakDitemukan").textContent = total.Tidak;
    document.getElementById("totalBaik").textContent = total.Baik;
    document.getElementById("totalRusakRingan").textContent = total.Ringan;
    document.getElementById("totalRusakBerat").textContent = total.Berat;
    document.getElementById("totalNilai").textContent = total.Nilai.toLocaleString("id-ID");

    document.getElementById("lastUpdate").textContent = "Data terakhir diperbarui: " + new Date().toLocaleTimeString();

    updateCharts(total);
  }

  function updateCharts(total){
    const ctx1 = document.getElementById("rekapKonfirmasi").getContext("2d");
    const ctx2 = document.getElementById("rekapKondisi").getContext("2d");
    const ctx3 = document.getElementById("rekapNilai").getContext("2d");

    if(chartKonfirmasi) chartKonfirmasi.destroy();
    if(chartKondisi) chartKondisi.destroy();
    if(chartNilai) chartNilai.destroy();

    chartKonfirmasi = new Chart(ctx1,{
      type:"pie",
      data:{labels:["Ditemukan","Tidak Ditemukan"],datasets:[{data:[total.Ditemukan,total.Tidak]}]}
    });

    chartKondisi = new Chart(ctx2,{
      type:"bar",
      data:{labels:["Baik","Rusak Ringan","Rusak Berat"],datasets:[{data:[total.Baik,total.Ringan,total.Berat]}]}
    });

    chartNilai = new Chart(ctx3,{
      type:"doughnut",
      data:{labels:["Nilai Barang"],datasets:[{data:[total.Nilai]}]}
    });
  }

  const filterSelect = document.getElementById("filterKecamatan");
  for (const nama of Object.keys(kecamatanEndpoints)) {
    const opt = document.createElement("option");
    opt.value = nama;
    opt.textContent = nama;
    filterSelect.appendChild(opt);
  }

  filterSelect.addEventListener("change", updateData);
  document.getElementById("searchBox").addEventListener("input", updateData);

  updateData();
  setInterval(updateData, 300000);
  </script>

 <!-- Footer -->
  <footer>
    <p>&copy; 2025 DINAS PENDIDIKAN DAN KEBUDAYAAN - Semua Hak Dilindungi.</p>
    <p id="about">Dibuat untuk monitoring KIB B secara digital dan transparan.</p>
  </footer>

</body>
</html>
